<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org/">

<head>
    <meta charset="UTF-8">
    <title>管理員權限管理</title>
</head>

<body class="bg-dark text-white">
    <div th:replace="~{display/navbar}"></div>
    <!-- 主要內容區域 -->
    <div class="container mt-5" style="padding-left: 270px; padding-top: 80px;">
        <h1 class="text-center">管理員權限管理</h1>

        <div class="mt-4">
            <h4>選擇權限以查詢管理員：</h4>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="none" id="permissionNone">
                <label class="form-check-label" for="permissionNone">
                    無任何權限
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="account" id="permissionAccount">
                <label class="form-check-label" for="permissionAccount">
                    會員管理
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="discount" id="permissionDiscount">
                <label class="form-check-label" for="permissionDiscount">
                    優惠券管理
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="order" id="permissionOrder">
                <label class="form-check-label" for="permissionOrder">
                    外帶訂單管理
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="rental" id="permissionRental">
                <label class="form-check-label" for="permissionRental">
                    餐具租借管理
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="reservation" id="permissionReservation">
                <label class="form-check-label" for="permissionReservation">
                    餐廳預訂管理
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="store" id="permissionStore">
                <label class="form-check-label" for="permissionStore">
                    線上商城管理
                </label>
            </div>
            <button id="searchBtn" class="btn btn-outline-light mt-3">查詢</button>
        </div>

        <table id="admin-table" class="table table-dark table-striped mt-4">
            <thead>
                <tr>
                    <th>管理員ID</th>
                    <th>管理員名稱</th>
                    <th>帳號</th>
                    <th>權限</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                <!-- JavaScript 動態加載資料 -->
            </tbody>
        </table>

        <div id="pagination" class="d-flex justify-content-between mt-4">
            <button id="prevPage" class="btn btn-outline-light">上一頁</button>
            <button id="nextPage" class="btn btn-outline-light">下一頁</button>
        </div>
    </div>

    <!-- 修改權限的模態框 -->
    <div class="modal fade" id="editPermissionsModal" tabindex="-1" aria-labelledby="editPermissionsLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content text-dark">
                <div class="modal-header">
                    <h5 class="modal-title" id="editPermissionsLabel">修改管理員權限</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editPermissionsForm">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="account" id="editPermissionAccount">
                            <label class="form-check-label" for="editPermissionAccount">會員管理</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="discount" id="editPermissionDiscount">
                            <label class="form-check-label" for="editPermissionDiscount">優惠券管理</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="order" id="editPermissionOrder">
                            <label class="form-check-label" for="editPermissionOrder">外帶訂單管理</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="rental" id="editPermissionRental">
                            <label class="form-check-label" for="editPermissionRental">餐具租借管理</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="reservation" id="editPermissionReservation">
                            <label class="form-check-label" for="editPermissionReservation">餐廳預訂管理</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="store" id="editPermissionStore">
                            <label class="form-check-label" for="editPermissionStore">線上商城管理</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" id="savePermissionsBtn" class="btn btn-primary">保存修改</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        let currentPage = 0;
        const pageSize = 10;
        let currentAdminId = null;
        let currentAdminRole = null;

        // 監聽查詢按鈕
        document.querySelector('#searchBtn').addEventListener('click', function () {
            const selectedPermissions = getSelectedPermissions();
            loadAdminsByPermissions(selectedPermissions, currentPage);
        });

        // 監聽上一頁按鈕
        document.querySelector('#prevPage').addEventListener('click', function () {
            if (currentPage > 0) {
                currentPage--;
                loadAdminsByPermissions(getSelectedPermissions(), currentPage);
            }
        });

        // 監聽下一頁按鈕
        document.querySelector('#nextPage').addEventListener('click', function () {
            currentPage++;
            loadAdminsByPermissions(getSelectedPermissions(), currentPage);
        });

        // 監聽「無任何權限」選項
        document.querySelector('#permissionNone').addEventListener('change', function () {
            if (this.checked) {
                document.querySelectorAll('.form-check-input').forEach(function (checkbox) {
                    if (checkbox.id !== 'permissionNone') {
                        checkbox.checked = false;
                    }
                });
            }
        });

        // 監聽其他權限選項
        document.querySelectorAll('.form-check-input').forEach(function (checkbox) {
            if (checkbox.id !== 'permissionNone') {
                checkbox.addEventListener('change', function () {
                    if (this.checked) {
                        document.querySelector('#permissionNone').checked = false;
                    }
                });
            }
        });

        function getSelectedPermissions() {
            const selectedPermissions = [];
            document.querySelectorAll('.form-check-input:checked').forEach(function (checkbox) {
                selectedPermissions.push(checkbox.value);
            });
            return selectedPermissions;
        }

        function loadAdminsByPermissions(permissions, page) {
            axios.post('/SpanTasty/admin/searchAdminsByPermissions', {
                permissions: permissions,
                page: page,
                size: pageSize
            })
            .then(function (response) {
                document.querySelector('#admin-table tbody').innerHTML = '';
                var admins = response.data.data;
                var tbody = document.querySelector('#admin-table tbody');
                admins.forEach(function (admin) {
                    var row = tbody.insertRow();
                    var permissionsHtml = '';
                    if (admin.permissions.length === 0) {
                        permissionsHtml = '<span>無任何權限</span>';
                    } else {
                        permissionsHtml = `<select class="form-select">`;
                        admin.permissions.forEach(function (permission) {
                            let permissionText = '';
                            switch (permission.permissionName) {
                                case "discount": permissionText = "優惠券管理"; break;
                                case "reservation": permissionText = "餐廳預訂管理"; break;
                                case "store": permissionText = "線上商城管理"; break;
                                case "account": permissionText = "會員管理"; break;
                                case "order": permissionText = "外帶訂單管理"; break;
                                case "rental": permissionText = "餐具租借管理"; break;
                                default: permissionText = permission.permissionName;
                            }
                            permissionsHtml += `<option>${permissionText}</option>`;
                        });
                        permissionsHtml += `</select>`;
                    }

                    let editButtonHtml = admin.adminId === 1 ? '<button class="btn btn-secondary btn-sm" disabled>不可修改</button>' : `<button class="btn btn-primary btn-sm" onclick="editPermissions(${admin.adminId})">修改權限</button>`;

                    row.innerHTML = `
                        <td>${admin.adminId}</td>
                        <td>${admin.adminName}</td>
                        <td>${admin.account}</td>
                        <td>${permissionsHtml}</td>
                        <td>${editButtonHtml}</td>
                    `;
                });
                document.querySelector('#prevPage').disabled = page === 0;
                document.querySelector('#nextPage').disabled = admins.length < pageSize;
            })
            .catch(function (error) {
                console.error(error);
                alert("查詢失敗，請稍後重試！");
            });
        }

        function editPermissions(adminId) {
            currentAdminId = adminId;
            axios.get(`/SpanTasty/admin/${adminId}/permissions`)
                .then(function (response) {
                    const permissions = response.data.data; // 從返回結果中獲取 data 部分
                    
                    // 先清除所有選項
                    document.querySelectorAll('#editPermissionsForm .form-check-input').forEach(function (checkbox) {
                        checkbox.checked = false;
                    });
                    
                    // 根據返回的權限資料勾選對應選項
                    permissions.forEach(function (permission) {
                        // 使用 permissionId 來匹配對應的 checkbox
                        const checkbox = document.querySelector(`#editPermissionsForm [value="${permission.permissionName}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    });
                    
                    // 打開模態框
                    new bootstrap.Modal(document.getElementById('editPermissionsModal')).show();
                })
                .catch(function (error) {
                    console.error(error);
                    alert("無法加載管理員權限！");
                });
        }

        document.querySelector('#savePermissionsBtn').addEventListener('click', function () {
            const updatedPermissions = [];
            document.querySelectorAll('#editPermissionsForm .form-check-input:checked').forEach(function (checkbox) {
                updatedPermissions.push(checkbox.value);
            });
            if (confirm("確定要修改此管理員的權限嗎？")) {
                axios.post(`/SpanTasty/admin/${currentAdminId}/permissions`, { permissions: updatedPermissions })
                    .then(function (response) {
                        alert("權限更新成功！");
                        new bootstrap.Modal(document.getElementById('editPermissionsModal')).hide();
                        loadAdminsByPermissions(getSelectedPermissions(), currentPage);
                    })
                    .catch(function (error) {
                        console.error(error);
                        alert("更新失敗，請稍後重試！");
                    });
            }
        });
    </script>
</body>

</html>