<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org/">

<head>
    <meta charset="UTF-8">
    <title>æŸ¥è©¢</title>
</head>

<body>
    <div th:replace="~{display/navbar}"></div>
    <div class="content">
        <div class="container mt-2">
            <h1 class="display-6">ğŸ“è¨‚å–®æŸ¥è©¢ğŸ“</h1>
            <!-- æŸ¥è©¢è¼¸å…¥æ¡†å’ŒæŒ‰éˆ• -->
            <div class="row mt-3">
                <div class="col-md-4">
                    <input type="text" id="idSearch" class="form-control" placeholder="è«‹è¼¸å…¥è¨‚å–®ç·¨è™Ÿ">
                </div>
                <div class="col-md-4">
                    <button id="idSearchBtn" class="btn btn-primary">æŸ¥è©¢</button>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-4">
                    <input type="text" id="phoneSearch" class="form-control" placeholder="è«‹è¼¸å…¥è¨‚è³¼äººé›»è©±">
                </div>
                <div class="col-md-4">
                    <button id="phoneSearchBtn" class="btn btn-primary">æŸ¥è©¢</button>
                </div>
            </div>
            <div class="table-responsive mt-3">
                <table id="demoData" class="table table-secondary table-striped table-hover text-center">
                    <thead class="thead-light">
                        <tr>
                            <th scope="col">è¨‚å–®ç·¨è™Ÿ</th>
                            <th scope="col">æœƒå“¡ç·¨è™Ÿ</th>
                            <th scope="col">è¨‚è³¼äººå§“å</th>
                            <th scope="col">è¨‚è³¼äººé›»è©±</th>
                            <th scope="col">è¨‚å–®é‡‘é¡</th>
                            <th scope="col">æˆç«‹æ™‚é–“</th>
                            <th scope="col">ç§Ÿå€Ÿå–®è™Ÿ</th>
                            <th scope="col">è¨‚å–®ç‹€æ…‹</th>
                            <th scope="col">é¤å»³åç¨±</th>
                            <th scope="col">è¨‚å–®å‚™è¨»</th>
                            <th scope="col">æŸ¥çœ‹æ˜ç´°</th>
                            <th scope="col">ä¿®æ”¹</th>
                            <th scope="col">åˆªé™¤</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Ajax -->
                    </tbody>
                </table>
            </div>
            <div class="col-12 d-flex justify-content-center">
            	<a href="http://localhost:8080/SpanTasty/order/togo" class="btn btn-secondary ms-2">è¿”å›å…¨éƒ¨</a>
            </div>
        </div>
    </div>

    <!-- modal for update -->
    <div class="modal fade" id="updateTogoModal" tabindex="-1" role="dialog" aria-labelledby="updateTogoModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="updateTogoModalLabel">æ›´æ–°è¨‚å–®è³‡è¨Š</h5>
                </div>
                <div class="modal-body">
                    <!-- æ›´æ–°çš„è¡¨å–® -->
                    <form id="updateTogoForm">
                        <div class="form-group mb-3">
                            <label for="memberId">æœƒå“¡ç·¨è™Ÿ</label>
                            <input type="text" class="form-control" id="memberId" placeholder="è¼¸å…¥æœƒå“¡ç·¨è™Ÿ">
                        </div>
                        <div class="form-group mb-3">
                            <label for="tgName">è¨‚è³¼äººå§“å</label>
                            <input type="text" class="form-control" id="tgName" placeholder="è¼¸å…¥é¡§å®¢å§“å">
                        </div>
                        <div class="form-group mb-3">
                            <label for="tgPhone">è¨‚è³¼äººé›»è©±</label>
                            <input type="text" class="form-control" id="tgPhone" placeholder="è¼¸å…¥é›»è©±">
                        </div>
                        <div class="form-group mb-3">
                            <label for="togoStatus">å–é¤ç‹€æ…‹</label>
                            <select class="form-control" id="togoStatus">
                                <option value="" selected>è«‹é¸æ“‡</option>
                                <option value="1">æœªå–é¤</option>
                                <option value="2">å·²å–é¤</option>
                                <option value="3">å·²å–æ¶ˆ</option>
                            </select>
                        </div>
                        <div class="form-group mb-3">
                            <label for="rentid">ç§Ÿå€Ÿå–®è™Ÿ</label>
                            <input type="text" class="form-control" id="rentId" placeholder="è¼¸å…¥ç§Ÿå€Ÿå–®è™Ÿ">
                        </div>
                        <div class="form-group mb-3">
                            <label for="togoMemo">å‚™è¨»</label>
                            <textarea class="form-control" id="togoMemo" placeholder="è¼¸å…¥å‚™è¨»"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal"
                        id="cancelChangesBtn">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" id="saveChangesBtn">ä¿å­˜ä¿®æ”¹</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            showSidebar('order');

            document.getElementById("idSearchBtn").addEventListener("click", function () {
                getTogoById();
            });
            document.getElementById("phoneSearchBtn").addEventListener("click", function () {
                getTogoByPhone();
            });

        })

         // id æŸ¥è©¢
        function getTogoById() {
            const togoId = document.getElementById("idSearch").value;
            // æª¢æŸ¥æ˜¯å¦ç‚ºç©ºä»¥åŠæ˜¯å¦ç¬¦åˆæ•¸å­—æ ¼å¼
            const idPattern = /^[0-9]+$/;
            if (!togoId) {
                alert("è«‹è¼¸å…¥è¨‚å–®ç·¨è™Ÿï¼");
                return;
            }
            // æª¢æŸ¥æ˜¯å¦ç¬¦åˆæ•¸å­—æ ¼å¼
            if (!idPattern.test(togoId)) {
                alert("è¨‚å–®ç·¨è™Ÿåªèƒ½åŒ…å«æ•¸å­—ï¼");
                return;
            }
            // ç™¼é€ GET è«‹æ±‚åˆ° /togo/{togoId}
            axios.get(`http://localhost:8080/SpanTasty/order/togo/${togoId}`)
                .then(function (response) {
                    console.log(response.data)
                    const togoData = response.data;

                    // æ¸…ç©ºè¡¨æ ¼å…§å®¹
                    const tbody = document.querySelector("#demoData tbody");
                    tbody.innerHTML = "";

                    // å‹•æ…‹ç”Ÿæˆè¡¨æ ¼å…§å®¹

                    const row = document.createElement("tr");
                    row.setAttribute("data-id", togoData.togoId);
                    const memberId = togoData.memberId !== null ? togoData.memberId : '';
                    const rentId = togoData.rentId !== null ? togoData.rentId : '';
                    const togoMemo = togoData.togoMemo !== null ? togoData.togoMemo : '';

                    row.innerHTML = `
                        <td>${togoData.togoId}</td>
                        <td>${togoData.memberId || ''}</td>
                        <td>${togoData.tgName}</td>
                        <td>${togoData.tgPhone}</td>
                        <td>${togoData.totalPrice}</td>
                        <td>${togoData.formattedDate}</td>
                        <td>${togoData.rentId || ''}</td>
                        <td>${getTogoStatusBadge(togoData.togoStatus)}</td>
                        <td>${togoData.restaurant.restaurantName}</td>
                        <td>${togoData.togoMemo || ''}</td>
                        <td><button class="btn btn-info" onclick="showTogoItems(${togoData.togoId})">æŸ¥çœ‹</button></td>
                        <td><button class="btn btn-warning" onclick="showUpdateModal(${togoData.togoId})">ä¿®æ”¹</button></td>
                        <td><button class="btn btn-danger" onclick="deleteTogo(${togoData.togoId})">åˆªé™¤</button></td>
                    `;

                    // æ·»åŠ åˆ°è¡¨æ ¼ä¸­
                    tbody.appendChild(row);
                    // æ¸…ç©ºè¼¸å…¥æ¡†
                    document.getElementById("idSearch").value = "";
                })
                .catch(function (error) {
                    console.error("æŸ¥è©¢è¨‚å–®æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š", error);
                    alert("æŸ¥è©¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥è¨‚å–®ç·¨è™Ÿã€‚");
                });
        }

        // phone æŸ¥è©¢
        function getTogoByPhone() {
            const tgPhone = document.getElementById("phoneSearch").value;
            //æª¢æŸ¥æ˜¯å¦è¼¸å…¥
            if (!tgPhone) {
                alert("è«‹è¼¸å…¥è¨‚è³¼äººé›»è©±è™Ÿç¢¼ï¼");
                return;
            }
            // æª¢æŸ¥æ˜¯å¦ç‚ºç©ºä»¥åŠæ˜¯å¦ç¬¦åˆæ•¸å­—æ ¼å¼
            const phonePattern = /^[0-9]+$/;
            if (!tgPhone) {
                alert("è«‹è¼¸å…¥è¨‚è³¼äººé›»è©±è™Ÿç¢¼ï¼");
                return;
            }
            // æª¢æŸ¥æ˜¯å¦ç¬¦åˆæ•¸å­—æ ¼å¼
            if (!phonePattern.test(tgPhone)) {
                alert("é›»è©±è™Ÿç¢¼åªèƒ½åŒ…å«æ•¸å­—ï¼");
                return;
            }
            const params = {
                tgPhone: tgPhone
            };
            // ç™¼é€ GET è«‹æ±‚
            axios.get('http://localhost:8080/SpanTasty/order/togo/phone', { params })
                .then(function (response) {
                    console.log(response.data)
                    const togoList = response.data;

                    // æ¸…ç©ºè¡¨æ ¼å…§å®¹
                    const tbody = document.querySelector("#demoData tbody");
                    tbody.innerHTML = "";

                    // å‹•æ…‹ç”Ÿæˆè¡¨æ ¼å…§å®¹

                    const memberId = togoList.memberId !== null ? togoList.memberId : '';
                    const rentId = togoList.rentId !== null ? togoList.rentId : '';
                    const togoMemo = togoList.togoMemo !== null ? togoList.togoMemo : '';

                    togoList.forEach(togoData => {
                        const row = document.createElement("tr");
                        row.setAttribute("data-id", togoData.togoId);
                        row.innerHTML = `
                        <td>${togoData.togoId}</td>
                        <td>${togoData.memberId || ''}</td>
                        <td>${togoData.tgName}</td>
                        <td>${togoData.tgPhone}</td>
                        <td>${togoData.totalPrice}</td>
                        <td>${togoData.formattedDate}</td>
                        <td>${togoData.rentId || ''}</td>
                        <td>${getTogoStatusBadge(togoData.togoStatus)}</td>
                        <td>${togoData.restaurant.restaurantName}</td>
                        <td>${togoData.togoMemo || ''}</td>
                        <td><button class="btn btn-info" onclick="showTogoItems(${togoData.togoId})">æŸ¥çœ‹</button></td>
                        <td><button class="btn btn-warning" onclick="showUpdateModal(${togoData.togoId})">ä¿®æ”¹</button></td>
                        <td><button class="btn btn-danger" onclick="deleteTogo(${togoData.togoId})">åˆªé™¤</button></td>
                    `;

                        // æ·»åŠ åˆ°è¡¨æ ¼ä¸­
                        tbody.appendChild(row);
                    })

                    // æ¸…ç©ºè¼¸å…¥æ¡†
                    document.getElementById("idSearch").value = "";
                })
                .catch(function (error) {
                    console.error("æŸ¥è©¢è¨‚å–®æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š", error);
                    alert("æŸ¥è©¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥è¨‚è³¼äººé›»è©±ã€‚");
                });
        }

        //åˆªé™¤(æ›´æ–°ç‹€æ…‹ç‚º3)
        function deleteTogo(togoId) {

            const isConfirmed = confirm("æ‚¨ç¢ºå®šè¦åˆªé™¤é€™å€‹è¨‚å–®å—ï¼Ÿ");
            if (isConfirmed) {
                const updateTogo = { togoId: togoId, togoStatus: 3 };
                axios.put(`http://localhost:8080/SpanTasty/order/togo/${togoId}`, updateTogo)
                    .then(function (response) {
                        console.log("åˆ é™¤æˆåŠŸï¼š", response.data);
                        alert("è¨‚å–®åˆªé™¤æˆåŠŸï¼");
                        updateTogoRow(togoId);
                    })
                    .catch(function (error) {
                        console.error("åˆªé™¤æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š", error);
                        alert("åˆªé™¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥è¨‚å–®ç·¨è™Ÿã€‚");
                    });
            }
        }

        // é¡¯ç¤ºmodalä¸”æœ‰åŸå…ˆçš„è³‡æ–™
        function showUpdateModal(togoId) {
            // togoIdæ‰¾è¦æ›´æ–°çš„è³‡æ–™
            axios.get(`http://localhost:8080/SpanTasty/order/togo/${togoId}`)
                .then(function (response) {
                    const togoData = response.data;

                    // å¡«å…¥modalè¡¨å–®
                    document.getElementById('memberId').value = togoData.memberId;
                    document.getElementById('tgName').value = togoData.tgName;
                    document.getElementById('tgPhone').value = togoData.tgPhone;
                    document.getElementById('togoStatus').value = togoData.togoStatus;
                    document.getElementById('rentId').value = togoData.rentId;
                    document.getElementById('togoMemo').value = togoData.togoMemo;

                    // é¡¯ç¤ºmodal
                    $('#updateTogoModal').modal('show');

                    // ç»‘å®šä¿å­˜æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ï¼ˆæ³¨æ„ï¼šä¸ºé¿å…é‡å¤ç»‘å®šï¼Œæ¯æ¬¡æ˜¾ç¤ºæ¨¡æ€æ¡†æ—¶é‡æ–°ç»‘å®šï¼‰
                    document.getElementById('saveChangesBtn').onclick = function () {
                        updateTogo(togoId);
                    };
                    document.getElementById('cancelChangesBtn').onclick = function () {
                        $('#updateTogoModal').modal('hide');
                    };
                })
                .catch(function (error) {
                    console.error("ç²å–è¨‚å–®æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š", error);
                    alert("å–å¾—è¨‚å–®è³‡è¨Šå¤±æ•—ã€‚");
                });
        }

        function updateTogo(togoId) {
            const updateTogo = {
                memberId: document.getElementById('memberId').value,
                tgName: document.getElementById('tgName').value,
                tgPhone: document.getElementById('tgPhone').value,
                togoStatus: document.getElementById('togoStatus').value,
                rentId: document.getElementById('rentId').value,
                togoMemo: document.getElementById('togoMemo').value
            };

            axios.put(`http://localhost:8080/SpanTasty/order/togo/${togoId}`, updateTogo)
                .then(function (response) {
                    console.log("æ›´æ–°æˆåŠŸï¼š", response.data);
                    alert("è¨‚å–®æ›´æ–°æˆåŠŸï¼");

                    // é—œé–‰modal
                    $('#updateTogoModal').modal('hide');

                    // é‡æ–°é¡¯ç¤ºè¨‚å–®è³‡è¨Š
                    updateTogoRow(togoId);
                })
                .catch(function (error) {
                    console.error("æ›´æ–°è¨‚å–®æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š", error);
                    alert("æ›´æ–°å¤±æ•—ã€‚");
                    $('#updateTogoModal').modal('hide');
                });

        }

        //é‡æ–°æŸ¥è©¢
        function updateTogoRow(togoId) {

            axios.get(`http://localhost:8080/SpanTasty/order/togo/${togoId}`)
                .then(function (response) {
                    const togoData = response.data;
                    const row = document.querySelector(`tr[data-id="${togoId}"]`);
                    const memberId = togoData.memberId !== null ? togoData.memberId : '';
                    const rentId = togoData.rentId !== null ? togoData.rentId : '';
                    const togoMemo = togoData.togoMemo !== null ? togoData.togoMemo : '';
                    const totalPrice = togoData.totalPrice !== null ? togoData.totalPrice : '';

                    if (row) {
                        row.innerHTML = `
                    <td>${togoData.togoId}</td>
                    <td>${togoData.memberId || ''}</td>
                    <td>${togoData.tgName}</td>
                    <td>${togoData.tgPhone}</td>
                    <td>${togoData.totalPrice || ''}</td>
                    <td>${togoData.formattedDate}</td>
                    <td>${togoData.rentId || ''}</td>
                    <td>${getTogoStatusBadge(togoData.togoStatus)}</td>
                    <td>${togoData.restaurant.restaurantName}</td>
                    <td>${togoData.togoMemo || ''}</td>
                    <td><button class="btn btn-info" onclick="showTogoItems(${togoData.togoId})">æŸ¥çœ‹</button></td>
                    <td><button class="btn btn-warning" onclick="showUpdateModal(${togoData.togoId})">ä¿®æ”¹</button></td>
                    <td><button class="btn btn-danger" onclick="deleteTogo(${togoData.togoId})">åˆªé™¤</button></td>
                `;
                    }
                })
                .catch(function (error) {
                    console.error("æ›´æ–°è¡Œæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š", error);
                });
        }

        //é¡¯ç¤ºtogoç‹€æ…‹
        function getTogoStatusBadge(status) {
            if (status === 1) {
                return '<span class="badge bg-warning">æœªå–é¤</span>';
            } else if (status === 2) {
                return '<span class="badge bg-success">å·²å–é¤</span>';
            } else if (status === 3) {
                return '<span class="badge bg-danger">å·²å–æ¶ˆ</span>';
            }
        }

        // æŸ¥è©¢è¨‚å–®æ˜ç´°
        function showTogoItems(togoId) {
            window.location.href = `http://localhost:8080/SpanTasty/order/togo/${togoId}/items`;
        }

    </script>
    <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <script th:src="@{/js/jquery-3.7.1.min.js}"></script>
    <script th:src="@{/js/axios.min.js}"></script>
</body>

</html>