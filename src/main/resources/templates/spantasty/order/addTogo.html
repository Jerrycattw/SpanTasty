<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org/">

<head>
    <meta charset="UTF-8">
    <title>æ–°å¢è¨‚å–®</title>
    <style>
        .description {
            padding-left: 5px;
            color: #ADADAD;
            font-size: 0.9em;
        }

        .error {
            padding-left: 5px;
            color: red;
            font-size: 0.7em;
        }
    </style>
    <script src="//cdnjs.cloudflare.com/ajax/libs/validate.js/0.13.1/validate.min.js"></script>
</head>

<body>
    <div th:replace="~{spantasty/display/navbar}"></div>
    <div class="content">
        <div class="container mt-1">
            <h1 class="display-6">ğŸ“æ–°å¢è¨‚å–®ğŸ“</h1>
            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <button class="btn btn-secondary btn-sm" id="autoFillBtn">ä¸€éµå¡«å…¥</button>
            </div>
            <form id="togoForm" class="row g-3 mt-1">
                <div class="col-md-4">
                    <label for="memberId" class="form-label">æœƒå“¡ç·¨è™Ÿ</label>
                    <input type="text" class="form-control" name="memberId" id="memberId">
                    <span class="error text-danger" id="memberIdError"></span>
                </div>
                <div class="col-md-4">
                    <label for="tgName" class="form-label">è¨‚è³¼äººå§“å</label>
                    <input type="text" class="form-control" name="tgName" id="tgName" required>
                    <span class="error text-danger" id="tgNameError"></span>
                </div>
                <div class="col-md-4">
                    <label for="tgPhone" class="form-label">è¨‚è³¼äººé›»è©±</label>
                    <input type="text" class="form-control" name="tgPhone" id="tgPhone" required>
                    <span class="error text-danger" id="tgPhoneError"></span>
                </div>
                <div class="col-md-4">
                    <label for="rentId" class="form-label">ç§Ÿå€Ÿå–®è™Ÿ</label>
                    <input type="text" class="form-control" name="rentId" id="rentId">
                    <span class="error text-danger" id="rentIdError"></span>
                </div>
                <div class="col-md-4">
                    <label for="restaurantId" class="form-label">å–é¤é¤å»³</label>
                    <select name="restaurantId" id="restaurantId" class="form-select" required>
                        <option value="" selected>è«‹é¸æ“‡é¤å»³</option>
                        <th:block th:each="restaurant : ${restaurants}">
                            <option th:value="${restaurant.restaurantId}" th:text="${restaurant.restaurantName}">
                            </option>
                        </th:block>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="togoStatus" class="form-label">å–é¤ç‹€æ…‹</label>
                    <select class="form-select" id="togoStatus" aria-label="Default select example" required>
                        <option selected value="">è«‹é¸æ“‡</option>
                        <option value="1">æœªå–é¤</option>
                        <option value="2">å·²å–é¤</option>
                        <option value="3">å·²å–æ¶ˆ</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="togoMemo" class="form-label">è¨‚å–®å‚™è¨»</label>
                    <textarea class="form-control" id="togoMemo" rows="3"></textarea>
                </div>
                <div class="col-12 d-flex justify-content-center">
                    <button type="submit" id="addBtn " class="btn btn-primary">è¨‚å–®æäº¤</button>
                    <a href="http://localhost:8080/SpanTasty/order/togo" class="btn btn-secondary ms-2">è¿”å›å…¨éƒ¨</a>
                </div>
            </form>
        </div>
    </div>


    <script>
        document.addEventListener("DOMContentLoaded", function (event) {
            showSidebar('order');



            document.getElementById("togoForm").addEventListener("submit", function (event) {
                event.preventDefault();
                if (validateForm()) {
                    // è¡¨å–®æ•¸æ“š
                    const newTogo = {
                        memberId: document.getElementById("memberId").value,
                        tgName: document.getElementById("tgName").value,
                        tgPhone: document.getElementById("tgPhone").value,
                        rentId: document.getElementById("rentId").value,
                        restaurantId: document.getElementById("restaurantId").value,
                        togoStatus: document.getElementById("togoStatus").value,
                        togoMemo: document.getElementById("togoMemo").value
                    };

                    // ç™¼é€ POST è«‹æ±‚
                    axios.post('http://localhost:8080/SpanTasty/order/togo', newTogo)
                        .then(function (response) {
                            console.log(response.data);
                            alert("è¨‚å–®å·²æˆåŠŸæäº¤ï¼");
                            //æäº¤å¾Œå›åˆ°getAllTogo
                            window.location.href = 'http://localhost:8080/SpanTasty/order/togo';
                        })
                        .catch(function (error) {
                            console.error("æäº¤è¨‚å–®æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š", error);
                            alert("æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                        })
                } else {
                    alert("è«‹ä¿®æ­£è¡¨å–®ä¸­çš„éŒ¯èª¤ï¼");
                }
            })


            document.getElementById("autoFillBtn").addEventListener("click", function () {
                // å¡«å…¥è¼¸å…¥æ¡†
                document.getElementById("memberId").value = "3";
                document.getElementById("tgName").value = "Johnson";
                document.getElementById("tgPhone").value = "0973829123";
                document.getElementById("restaurantId").value = "3";
                document.getElementById("togoStatus").value = "1";
                document.getElementById("togoMemo").value = "ä¸ç”¨é¤å…·";

            });
        })

        // è¡¨å–®é©—è­‰çš„ constraints å’Œé‚è¼¯èˆ‡ä¹‹å‰ä¸€æ¨£
        const constraints = {
            memberId: {
                numericality: {
                    onlyInteger: true,
                    greaterThan: 0,
                    message: "æœƒå“¡ç·¨è™Ÿæ ¼å¼éŒ¯èª¤ï¼Œåªèƒ½ç‚ºæ•¸å­—"
                }
            },
            tgName: {
                presence: {
                    allowEmpty: false,
                    message: "å–é¤äººå§“åä¸èƒ½ç‚ºç©ºç™½"
                }
            },
            tgPhone: {
                format: {
                    onlyInteger: true,
                    pattern: /^09\d{8}$/,
                    message: "é›»è©±æ ¼å¼éŒ¯èª¤ä¸”å–é¤é›»è©±ä¸èƒ½ç‚ºç©ºç™½"
                },
                presence: {
                    allowEmpty: false,
                    message: "å–é¤é›»è©±ä¸èƒ½ç‚ºç©ºç™½"
                }
            },
            rentId: {
                numericality: {
                    onlyInteger: true,
                    greaterThan: 0,
                    message: "ç§Ÿå€Ÿå–®è™Ÿæ ¼å¼éŒ¯èª¤ï¼Œåªèƒ½ç‚ºæ•¸å­—"
                }
            }
        };

        function validateForm() {
            const isValid = true;
            ['memberId', 'tgName', 'tgPhone', 'rentId'].forEach(field => {
                const input = document.querySelector(`input[name="${field}"]`);
                validateField(input, field);
                if (document.getElementById(`${field}Error`).textContent !== '') {
                    isValid = false;
                }
            });
            return isValid;
        }

        // é©—è­‰å­—æ®µå‡½æ•¸
        function validateField(input, fieldName) {
            const value = input.value;
            const errors = validate({ [fieldName]: value }, { [fieldName]: constraints[fieldName] });
            const errorSpan = document.getElementById(`${fieldName}Error`);

            if (errors && errors[fieldName]) {
                // ä½¿ç”¨ constraints ä¸­çš„ message ä¾†é¡¯ç¤ºéŒ¯èª¤ä¿¡æ¯
                if (constraints[fieldName].presence) {
                    errorSpan.textContent = constraints[fieldName].presence.message;
                    if (constraints[fieldName].format) {
                        errorSpan.textContent = constraints[fieldName].format.message;
                    } else if (constraints[fieldName].presence) {
                        errorSpan.textContent = constraints[fieldName].numericality.message;
                    }
                } else {
                    if (constraints[fieldName].format) {
                        errorSpan.textContent = constraints[fieldName].format.message;
                    } else if (constraints[fieldName].presence) {
                        errorSpan.textContent = constraints[fieldName].numericality.message;
                    }
                }

            } else {
                errorSpan.textContent = '';
            }
        }

        // ç¶å®š blur äº‹ä»¶ä¾†é©—è­‰è¼¸å…¥æ¡†
        const memberId = document.getElementById('memberId');
        const tgName = document.getElementById('tgName');
        const tgPhone = document.getElementById('tgPhone');
        const rentId = document.getElementById('rentId');

        memberId.addEventListener('blur', function () {
            console.log("memberId blur triggered");
            validateField(this, 'memberId');
        });

        tgName.addEventListener('blur', function () {
            console.log("tgName blur triggered");
            validateField(this, 'tgName');
        });

        tgPhone.addEventListener('blur', function () {
            console.log("tgPhone blur triggered");
            validateField(this, 'tgPhone');
        });

        rentId.addEventListener('blur', function () {
            console.log("rentId blur triggered");
            validateField(this, 'rentId');
        });


    </script>

    <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <script th:src="@{/js/jquery-3.7.1.min.js}"></script>
    <script th:src="@{/js/axios.min.js}"></script>
</body>

</html>