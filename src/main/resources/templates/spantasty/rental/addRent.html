<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org/">
<head>
<meta charset="UTF-8">
<title>新增訂單</title>
<style>
.h {
    text-align: center;
}

form {
    width: 60%;
    margin: 0 auto;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    background-color: #c8e6c9;
}

.rent-input {
    width: 86%;
    padding: 5px;
    margin-bottom: 0px;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-sizing: border-box;
}

.item-entry {
    display: flex;
    align-items: center;
    margin-bottom: 0px;
}

.item-input {
    width: 200px;
    margin-left: 0px;
    padding: 0px;
    height: 30px;
    width: 100%;
}

.item-column {
    width: 220px;
    margin-left: 10px;
    padding: 0px;
}

.delete-button {
    background-color: #fff;
    border: 2px solid #000;
    padding: 0px 10px;
    cursor: pointer;
    margin-left: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    height: 30px;
}

.table {
    background-color: #f1f8e9;
}

.table thead {
    background-color: #a5d6a7;
    color: #1b5e20;
}

.body {
    background-color: #e9f7ef;
}
</style>
</head>
<body class="body">
<div th:replace="~{spantasty/display/navbar}"></div>
<div class="content" id="container">
<h3 class="h">新增租借訂單</h3>
<form th:action="@{/rent/addPost}" method="post">
<table class="table w-100 table-striped" id="table">
    <tr><td>租借押金: <input type="text" class="rent-input" id="totalAmount" name="rentDeposit" readonly /></td></tr>
    <tr><td>租借餐廳:
        <select name="restaurantId" id="restaurantId" class="rent-input" required >
            <option value="" selected disabled>請選擇租借餐廳</option>
            <option th:each="restaurant : ${restaurants}" th:value="${restaurant.restaurantId}" th:text="${restaurant.restaurantName}"></option>
        </select>
    </td></tr>
    <tr><td>租借會員:
        <select name="memberId" class="rent-input" required>
            <option value="" selected disabled>請選擇會員編號</option>
            <option th:each="member : ${members}" th:value="${member.memberId}" th:text="${member.account}"></option>
        </select>
    </td></tr>
</table>
<div id="rentItemsContainer">
<h4 class="h">輸入租借訂單項目</h4>
<div class="item-entry">
<table class="table table-striped">
    <tr>
        <td class="item-column">餐具編號:
            <select name="tablewareId[0]" id="tablewareId"  class="item-input" onchange="handleSelectChange(this)"required>
                <option value="" selected disabled>請選擇餐具編號</option>
                <option th:each="tableware : ${tablewares}" th:value="${tableware.tablewareId}" th:data-deposit="${tableware.tablewareDeposit}" th:text="${tableware.tablewareName}"></option>
            </select>
        </td>
        <td class="item-column">租借數量: <input type="number" class="item-input" name="rentItemQuantity" min="1" oninput="updateDepositByQuantity(this)" /></td>
        <td class="item-column"> 租借押金: <input type="number" class="item-input" name="rentItemDeposit" readonly /></td>
        <td class="item-column"><br /><button class="delete-button" type="button"onclick="removeRentItem(this)">刪除</button></td>
    </tr>
</table>
</div>
</div>
<button type="button" id="add-item-button">新增訂單明細</button>
<button type="submit">新增訂單</button>
</form>
</div>
<script>
document.addEventListener("DOMContentLoaded", function () {
    showSidebar('rental');
});
</script>
<script type="text/template" id="tableware-options-template">
	<option value="" selected disabled>請選擇餐具編號</option>
    <option th:each="tableware : ${tablewares}" th:value="${tableware.tablewareId}" th:data-deposit="${tableware.tablewareDeposit}" th:text="${tableware.tablewareName}"></option>
</script>
<script>
let rentItemIndex = 0;

// 新增訂單明細
document.getElementById('add-item-button').addEventListener('click', function () {
    rentItemIndex++;
    addRentItem(rentItemIndex);
    disableSelectedOptions();
});

// 新增租借項目函數
function addRentItem(index) {
    const optionsTemplate = document.getElementById('tableware-options-template').innerHTML;
    const itemEntryHTML = `
        <div class="item-entry">
            <table class="table table-striped">
                <tr>
                    <td class="item-column">餐具編號:
                        <select name="tablewareId[${index}]" id="tablewareId" class="item-input" onchange="handleSelectChange(this)" required>
                            ${optionsTemplate}
                        </select>
                    </td>
                    <td class="item-column">租借數量:<input type="number" class="item-input" name="rentItemQuantity[${index}]" min="1" oninput="updateDepositByQuantity(this)" /></td>
                    <td class="item-column">租借押金:<input type="number" class="item-input" name="rentItemDeposit[${index}]" readonly /></td>
                    <td class="item-column"><br/><button class="delete-button" type="button" onclick="removeRentItem(this)">刪除</button></td>
                </tr>
            </table>
        </div>
    `;
    document.getElementById('rentItemsContainer').insertAdjacentHTML('beforeend', itemEntryHTML);
}

// 禁用已選過的餐具編號
function disableSelectedOptions(currentSelect = null) {
    const allSelectElements = document.querySelectorAll('.item-input[name^="tablewareId"]');
    const selectedValues = Array.from(allSelectElements).map(select => select.value).filter(value => value !== "");

    allSelectElements.forEach(select=> {
    // 將所有後續的 select 選項進行處理
        Array.from(select.options).forEach(option => {
            // 當前選擇的值，讓後續的 select 隱藏掉該選項
            if (option.value === currentValue) {
                option.hidden = true;
            } else {
                // 如果這個選項不是其他 select 中已選擇過的，解除隱藏
                const alreadySelectedValues = Array.from(allSelectElements)
                    .filter(sel => sel !== select)
                    .map(sel => sel.value)
                    .filter(value => value !== "");
                option.hidden = alreadySelectedValues.includes(option.value);
            }
        });
	});
}

// 處理餐具選擇變化
function handleSelectChange(selectElement) {
    const rentItemRow = selectElement.closest('.item-entry');
    const quantityInput = rentItemRow.querySelector('input[name^="rentItemQuantity"]');
    const restaurantId = document.getElementById('restaurantId').value;
    const tablewareId = selectElement.value;

    if (tablewareId) {
        fetchStock(restaurantId, tablewareId, quantityInput, selectElement);
    }

    disableSelectedOptions(selectElement);
    updateTotalAmount();
}

// 根據餐廳和餐具ID查詢庫存
function fetchStock(restaurantId, tablewareId, quantityInput, selectElement) {
    const url = 'http://localhost:8080/SpanTasty/rent/check';
    let stock = {
        restaurantId: restaurantId,
        tablewareId: tablewareId
    };

    axios.post(url, stock).then(response => {
        const stock = response.data;
        if (stock === 0) {
            alert('該餐具已無庫存');
            console.log(selectElement.options);
            const optionToHide = Array.from(selectElement.options).find(option => option.value === tablewareId);
            if (optionToHide) {
                optionToHide.hidden = true; // 隱藏該選項
                optionToHide.setAttribute('data-out-of-stock', 'true'); // 加入自定義屬性標記庫存為 0
            }
            selectElement.selectedIndex = 0;
            
        } else {
            quantityInput.value = Math.min(Number(quantityInput.value) || 1, stock);
            quantityInput.max = stock;
            quantityInput.placeholder = `最大可租借數量: ${stock}`;
            updateDeposit(selectElement);
        }
    }).catch(error => {
        console.error('Error fetching stock:', error);
        alert('餐廳庫存為0');
    });
}

// 移除訂單項目
function removeRentItem(button) {
    const rentItem = button.closest('.item-entry');
    rentItem.remove();
    disableSelectedOptions();
    updateTotalAmount();
}


// 更新押金值
function updateDeposit(selectElement) {
    const selectedOption = selectElement.options[selectElement.selectedIndex];
    const deposit = selectedOption.getAttribute('data-deposit');
    const quantityInput = selectElement.closest('.item-entry').querySelector('input[name^="rentItemQuantity"]');
    const rentItemDepositInput = selectElement.closest('.item-entry').querySelector('input[name^="rentItemDeposit"]');

    if (deposit && rentItemDepositInput) {
        rentItemDepositInput.value = deposit * quantityInput.value;
    }

    updateTotalAmount();
}

// 根據數量更新押金
function updateDepositByQuantity(quantityInput) {
    const selectElement = quantityInput.closest('.item-entry').querySelector('select[name^="tablewareId"]');
    const maxStock = quantityInput.max;

    if (Number(quantityInput.value) == Number(maxStock)) {
        alert('租借數量已達餐廳最大庫存數量');
        quantityInput.value = maxStock;
    }

    updateDeposit(selectElement);
}

// 計算訂單總金額
function updateTotalAmount() {
    let totalAmount = 0;
    document.querySelectorAll('input[name^="rentItemDeposit"]').forEach(input => {
        totalAmount += parseFloat(input.value) || 0;
    });
    document.getElementById('totalAmount').value = totalAmount;
}
</script>
<script>
// // 禁用已選過的餐具編號
// function disableSelectedOptions() {
//     const allSelectElements = document.querySelectorAll('.item-input[name^="tablewareId"]');
//     const selectedValues = Array.from(allSelectElements)
//         .map(select => select.value)
//         .filter(value => value !== "");
//     allSelectElements.forEach(select => {
//         Array.from(select.options).forEach(option => {
//             if (selectedValues.includes(option.value)) {
//                 option.hidden = true; // 禁用已選過的選項
//             } else {
//                 option.hidden = false; // 解除禁用狀態
//             }
//         });
//     });
// }

// // 更新押金值和數量自動跳為1
// function handleSelectChange(selectElement) {
// 	const selectedValues = Array.from(document.querySelectorAll('select[id^="tablewareId"]'))
//         .map(select => select.value)
//         .filter(value => value !== "");
//     const rentItemRow = selectElement.closest('.item-entry');
//     const quantityInput = rentItemRow.querySelector('input[name^="rentItemQuantity"]');
//     const restaurantId = document.getElementById('restaurantId').value; // 取得餐廳ID
//     const tablewareId = selectElement.value; // 取得餐具ID
// 	if (selectedValues.includes(tablewareId)) {
//         return; // 避免重複處理已選擇過的餐具
//     }
// 	const url = 'http://localhost:8080/SpanTasty/rent/check';
//     if (restaurantId && tablewareId) {
//         let stock = {
//         	restaurantId: restaurantId,
//             tablewareId: tablewareId
//         };
//         axios.post(url, stock)
//         .then(response => {
//             const stock = response.data;
//             if (stock === 0) {
//                 alert('該餐具已無庫存');
//                 selectElement.selectedIndex = 0; // 回到 "請選擇餐具編號"
//             } else {
//                 quantityInput.value = Math.min(Number(quantityInput.value) || 1, stock);
//                 quantityInput.max = stock;
//                 quantityInput.placeholder = `最大可租借數量: ${stock}`;
//                 updateDeposit(selectElement);
//             }
//         })
//         .catch(error => {
//             console.error('Error fetching stock:', error);
//             alert('餐廳庫存為0');
//         });
//     }
//     disableSelectedOptions();
//     updateTotalAmount();
// }
</script>
</body>
</html>