<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org/">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>新增環保用具</title>
<link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
<style>
.h {
	text-align: center;
}
form {
	width: 60%;
	margin: 0 auto;
	padding: 20px;
	border-radius: 10px;
	box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
	background-color: #ffd966;
}
</style>
</head>
<body>
    <div th:replace="~{display/navbar}"></div>
    <div class="content" id="container">
        <h3 class="h">請輸入想搜尋關鍵字</h3>
        <table>
            <tr><th>訂單編號:
				<select id="rentId">
					<option value="" selected disabled>請選擇訂單編號</option>
					<option th:each="rent : ${rents}" th:value="${rent.rentId}" th:text="${rent.rentId}"></option>
				</select>
            
			租借會員:
				<select id="memberId">
	                <option value="" selected disabled>請選擇會員編號</option>
					<option th:each="member : ${members}" th:value="${member.memberId}" th:text="${member.account}"></option>
                </select>
			
			租借餐廳: 
				<select id="restaurantId">
	                <option value="" selected disabled>請選擇租借餐廳</option>
	                <option th:each="restaurant : ${restaurants}" th:value="${restaurant.restaurantId}" th:text="${restaurant.restaurantName}"></option>
                </select>
			
			租借狀態: 
					<input type="radio" name="rentStatus" value="1" id="status_1" />1:出租中 
					<input type="radio" name="rentStatus" value="2" id="status_2" />2:已歸還
			
			查找日期: 
					開始<input type="date" id="rentDateStart" /> 
					結束<input type="date" id="rentDateEnd" />
					<button id="send_btn" class="btn btn-primary btn-sm">確認</button>
					<button id="clear_btn" class="btn btn-secondary btn-sm">清空所有選項</button>
			</th></tr>
		</table>
		
		<table class="table table-warning table-striped text-center" id="table"></table>
    </div>
   <script>
    const url = 'http://localhost:8080/SpanTasty/rent/get';
    const sendBtn = document.getElementById('send_btn');
    const table = document.getElementById('table');
    sendBtn.addEventListener('click', (e)=>{
    	sendBtn.disabled = true;
        const rentId = document.getElementById('rentId').value;
        const memberId = document.getElementById('memberId').value;
        const restaurantId = document.getElementById('restaurantId').value;
        const rentStatus = document.querySelector('input[name="rentStatus"]:checked') ? document.querySelector('input[name="rentStatus"]:checked').value : null;
        const rentDateStart = document.getElementById('rentDateStart').value;
        const rentDateEnd = document.getElementById('rentDateEnd').value;
        let dtoObject = {
            rentId: rentId,
            memberId: memberId,
            restaurantId: restaurantId,
            rentStatus: rentStatus ? parseInt(rentStatus) : null,
            rentDateStart: rentDateStart,
            rentDateEnd: rentDateEnd
        }
        axios.post(url,dtoObject)
        .then(res => {
            const rents = res.data;
            htmlMaker(rents);
        })
        .catch(err => {
            console.error(err); 
        })
        .finally(() => {
            sendBtn.disabled = false; // 请求完成后重新启用按钮
        });
    })
	
	const formatDate = (dateString) => {
	    if (!dateString) return '';
	    const date = new Date(dateString);
	    return `${date.getFullYear()}年${(date.getMonth() + 1).toString().padStart(2, '0')}月${date.getDate().toString().padStart(2, '0')}日`;
	};

	function getRentItem(event, id) {
	    //event.preventDefault(); // 阻止默认提交行为
	    const getUrl = `http://localhost:8080/SpanTasty/rent/set/${id}?action=get`;
	    window.location.href = getUrl;
	}
	
    function htmlMaker(rents) {
        table.innerHTML = '';
        
        if (rents.length === 0) {
	        table.innerHTML = '<h6>沒有找到相關結果</h6>';
	        return;
	    }
        const thead = document.createElement('thead');
        thead.innerHTML = 
        `
		<tr>
            <th>訂單編號</th>
            <th>租借押金</th>
            <th>租借日期</th>
            <th>租借餐廳</th>
            <th>租借會員</th>
            <th>預定歸還</th>
            <th>實際歸還</th>
            <th>租借狀態</th>
            <th>訂單備註</th>
            <th>歸還餐廳</th>
            <th>查看訂單</th>
        </tr>
		`;
        table.appendChild(thead);
        
        const tbody = document.createElement('tbody');

        rents.forEach(rent =>{
        	let status = '';
	        if (rent.rentStatus === 1) {
	            status = '<span class="badge bg-success text-white">出租中</span>';
	        } else if (rent.rentStatus === 2) {
	            status = '<span class="badge bg-danger text-white">已歸還</span>';
	        }
        	const tr = document.createElement('tr');
            tr.innerHTML = 
            `
			<td>${rent.rentId}</td>
			<td>${rent.rentDeposit}</td>
			<td>${formatDate(rent.rentDate)}</td>
			<td>${rent.restaurantId}</td>
			<td>${rent.memberId}</td>
			<td>${formatDate(rent.dueDate)}</td>
        	<td>${formatDate(rent.returnDate)}</td>
			<td class="align-middle">${status}</td>
			<td>${rent.rentMemo}</td>
			<td>${rent.returnRestaurantId}</td>
			<td class="align-middle">
			    <button onclick="getRentItem(event, ${rent.rentId})" class="btn btn-light btn-sm">查看</button>
			</td>
            `;
            tbody.appendChild(tr);
        });
        table.appendChild(tbody);
    }
    
    const clearBtn = document.getElementById('clear_btn');

	clearBtn.addEventListener('click', (e) => {
	    // 清空所有輸入框和選項
	    document.getElementById('rentId').value = '';
	    document.getElementById('memberId').value = '';
	    document.getElementById('restaurantId').value = '';
	    document.getElementById('rentDateStart').value = '';
	    document.getElementById('rentDateEnd').value = '';
	
	    // 清空租借狀態的單選按鈕選中狀態
	    const rentStatusRadios = document.getElementsByName('rentStatus');
	    rentStatusRadios.forEach(radio => {
	        radio.checked = false;
	    });
	});
</script>
   <script>
	document.addEventListener("DOMContentLoaded", function() {
		showSidebar('rental');
	});
</script>
    <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <script th:src="@{/js/jquery-3.7.1.min.js}"></script>
    <script th:src="@{/js/axios.min.js}"></script>
</body>
</html>