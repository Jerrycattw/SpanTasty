<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org/">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>會員中心</title>
  <link rel="stylesheet" href="/SpanTasty/starcups/css/bootstrap.css">
  <link rel="stylesheet" href="/SpanTasty/starcups/css/fonts.css">
  <link rel="stylesheet" href="/SpanTasty/starcups/css/style.css">
  <style>
    .user-avatar {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 275px;
      height: 275px;
      background-color: #f0f0f0;
      border-radius: 50%;
      border: 2px solid #ccc;
      overflow: hidden;
      margin: 0 auto;
    }

    /* 確保圖片可以完整填滿容器 */
    .user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .personal-info-table {
      width: 100%;
      margin: 20px auto;
      font-size: 18px;
    }

    .personal-info-table th,
    .personal-info-table td {
      padding: 10px;
      text-align: left;
    }

    .personal-info-table th {
      width: 40%;
      font-weight: bold;
      text-align: right;
    }
    
        .card-body {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
  </style>
</head>

<body>

  <div th:replace="~{/starcups/display/navbar}"></div>
  
  
      <section class="section breadcrumbs-custom-inset">
      <div class="breadcrumbs-custom context-dark">
        <div class="container">
          <h2 class="breadcrumbs-custom-title">會員中心</h2>
          <ul class="breadcrumbs-custom-path">
            <li><a href="/SpanTasty/StarCups">Home</a></li>
            <li><a href="/SpanTasty/StarCups/memberCenter">會員中心</a></li>
            <li class="active">帳戶管理</li>
          </ul>
        </div>
        <div class="box-position novi-bg novi-bg-img" style="background-image: url(images/bg-breadcrumbs.jpg);"></div>
      </div>
    </section>  

  <section class="section novi-bg novi-bg-img section-xl bg-default text-md-start">
    <div class="container">
      <div class="row row-50 justify-content-md-center">
        <!-- 左側按鈕欄 -->
        <div class="col-md-4">
          <h4 class="text-spacing-50">會員中心</h4>
          <div class="list-group">
            <button class="button button-block button-secondary button-ujarak" id="btn-personal-info">
              <span class="icon fa fa-user"></span> 個人資訊
            </button>
            <button class="button button-block button-secondary button-ujarak" id="btn-change-password">
              <span class="icon fa fa-key"></span> 修改密碼
            </button>
            <button class="button button-block button-secondary button-ujarak" id="btn-change-contact">
              <span class="icon fa fa-address-book"></span> 修改聯絡資訊
            </button>
            <button class="button button-block button-secondary button-ujarak" id="btn-change-avatar">
              <span class="icon fa fa-image"></span> 修改頭像
            </button>
          </div>
        </div>

        <!-- 右側內容區域 -->
        <div class="col-md-8">
          <!-- 個人資訊 -->
          <div id="personal-info" class="content-section">
            <h4 class="text-spacing-50 text-center mb-2">個人資訊</h4>
            <div class="card mx-auto">
              <div class="card-body">
                <!-- 頭像顯示區域 -->
                <div class="user-avatar mb-4" id="personal-preview-avatar">
                  <img id="personal-current-avatar" src="/SpanTasty/starcups/images/account/defaultUser.jpeg" alt="頭像"
                    class="rounded-circle border">
                </div>
                <div class="personal-info-details">
                  <table class="personal-info-table">
                    <tr>
                      <th>姓名：</th>
                      <td><span id="member-name">未設定</span></td>
                    </tr>
                    <tr>
                      <th>生日：</th>
                      <td><span id="birthday">未設定</span></td>
                    </tr>
                    <tr>
                      <th>電話：</th>
                      <td><span id="memberPhone">未設定</span></td>
                    </tr>
                    <tr>
                      <th>聯絡地址：</th>
                      <td><span id="memberAddress">未設定</span></td>
                    </tr>
                    <tr>
                      <th>信箱：</th>
                      <td><span id="member-email">未設定</span></td>
                    </tr>
                    <tr>
                      <th>註冊日期：</th>
                      <td><span id="register-date">未設定</span></td>
                    </tr>
                    <tr>
                      <th>最近登入：</th>
                      <td><span id="last-login">未設定</span></td>
                    </tr>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- 修改密碼表單 -->
          <div id="change-password" class="content-section" style="display:none;">
            <h4 class="text-spacing-50">修改密碼</h4>
            <form>
              <div class="form-group">
                <label for="current-password">原密碼</label>
                <input class="form-control" id="current-password" type="password" required>
              </div>
              <div class="form-group">
                <label for="new-password">新密碼</label>
                <input class="form-control" id="new-password" type="password" required>
              </div>
              <div class="form-group">
                <label for="confirm-password">確認新密碼</label>
                <input class="form-control" id="confirm-password" type="password" required>
              </div>
              <button class="button button-block button-secondary" type="submit">修改密碼</button>
            </form>
          </div>
          
          <!-- 修改聯絡方式 -->
          <div id="change-contact" class="content-section" style="display:none;">
            <h4 class="text-spacing-50">修改聯絡資訊</h4>
            <form>
              <div class="form-group">
                <label for="contact-phone">電話</label>
                <input class="form-control" id="contact-phone" type="text">
              </div>
              <div class="form-group">
                <label for="contact-email">信箱</label>
                <input class="form-control" id="contact-email" type="email">
              </div>
              <div class="form-group">
                <label for="contact-address">地址</label>
                <input class="form-control" id="contact-address" type="text">
              </div>
              <button class="button button-block button-secondary" type="button" id="update-contact-button">更新聯絡資訊</button>
            </form>
          </div>

          <!-- 修改頭像 -->
          <div id="change-avatar" class="content-section" style="display:none;">
            <h4 class="text-spacing-50">修改頭像</h4>
            <div class="card">
              <div class="card-body text-center">
                <div class="user-avatar mb-3" id="change-preview-avatar">
                  <img id="change-current-avatar" src="/SpanTasty/starcups/images/account/defaultUser.jpeg" alt="頭像"
                    width="300" height="300">
                </div>
                <div class="form-group">
                  <input type="file" id="avatar-input" class="form-control" accept="image/*">
                </div>
                <button class="button button-secondary" id="confirm-avatar" style="display:none;">確定更換頭像</button>
                <button class="button button-secondary" id="remove-avatar">移除頭像</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <div th:replace="~{starcups/display/footer}"></div>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="/SpanTasty/starcups/js/core.min.js"></script>
  <script src="/SpanTasty/starcups/js/script.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
        const token = localStorage.getItem('token');

    // 在頁面加載時先檢查是否有 token，如果沒有則跳轉到首頁
    if (!token) {
      alert('請先登入');
      window.location.href = '/SpanTasty/StarCups';
    } else {
      // 若有 token，則繼續執行其他功能
      getProfile();
      getAvatar();
    }
    
      const urlParams = new URLSearchParams(window.location.search);
      const section = urlParams.get('section');
      
      const personalInfoSection = document.getElementById('personal-info');
      const changePasswordSection = document.getElementById('change-password');
      const changeContactSection = document.getElementById('change-contact');
      const changeAvatarSection = document.getElementById('change-avatar');
      
      const breadcrumbPath = document.querySelector('.breadcrumbs-custom-path .active');
      
      if (section === 'info') {
        personalInfoSection.style.display = 'block';
        changePasswordSection.style.display = 'none';
        changeAvatarSection.style.display = 'none';
        changeContactSection.style.display = 'none';
        breadcrumbPath.textContent = '個人資訊';
    } else if (section === 'password') {
        personalInfoSection.style.display = 'none';
        changePasswordSection.style.display = 'block';
        changeAvatarSection.style.display = 'none';
        changeContactSection.style.display = 'none';
        breadcrumbPath.textContent = '修改密碼';
    }else if (section === 'contact') {
          personalInfoSection.style.display = 'none';
          changePasswordSection.style.display = 'none';
          changeAvatarSection.style.display = 'none';
          changeContactSection.style.display = 'block';
          breadcrumbPath.textContent = '修改聯絡方式';
     }else if (section === 'avatar') {
        personalInfoSection.style.display = 'none';
        changePasswordSection.style.display = 'none';
        changeAvatarSection.style.display = 'block';
        changeContactSection.style.display = 'none';
        breadcrumbPath.textContent = '更新頭像';
    } else {
        // 默認顯示個人資訊
        personalInfoSection.style.display = 'block';
        changePasswordSection.style.display = 'none';
        changeAvatarSection.style.display = 'none';
        changeContactSection.style.display = 'none';
        breadcrumbPath.textContent = '個人資訊';
    }

      const avatarInput = document.getElementById('avatar-input');
      const confirmAvatarButton = document.getElementById('confirm-avatar');
      const removeAvatarButton = document.getElementById('remove-avatar');

      
      //修改聯絡方式內容
      const contactPhoneInput = document.getElementById('contact-phone');
      const contactEmailInput = document.getElementById('contact-email');
      const contactAddressInput = document.getElementById('contact-address');
      const updateContactButton = document.getElementById('update-contact-button');


      const personalCurrentAvatar = document.getElementById('personal-current-avatar');
      const changeCurrentAvatar = document.getElementById('change-current-avatar');

      //個人資訊框內容
      const memberName = document.getElementById('member-name');
      const memberEmail = document.getElementById('member-email');
      const registerDate = document.getElementById('register-date');
      const birthday = document.getElementById('birthday');
      const lastLogin = document.getElementById('last-login');
      const memberPhone = document.getElementById('memberPhone');
      const memberAddress= document.getElementById('memberAddress');

      //按鈕
      const btnPersonalInfo = document.getElementById('btn-personal-info');
      const btnChangePassword = document.getElementById('btn-change-password');
      const btnChangeAvatar = document.getElementById('btn-change-avatar');
      const btnChangeContact = document.getElementById('btn-change-contact');

      // 修改密碼相關的元素
      const currentPasswordInput = document.getElementById('current-password');
      const newPasswordInput = document.getElementById('new-password');
      const confirmPasswordInput = document.getElementById('confirm-password');
      const changePasswordForm = changePasswordSection.querySelector('form');

      // 顯示個人資訊
      btnPersonalInfo.addEventListener('click', function () {
        personalInfoSection.style.display = 'block';
        changePasswordSection.style.display = 'none';
        changeAvatarSection.style.display = 'none';
        changeContactSection.style.display = 'none';
        breadcrumbPath.textContent = '個人資訊';
        getProfile();
      });

      // 顯示修改密碼表單
      btnChangePassword.addEventListener('click', function () {
        personalInfoSection.style.display = 'none';
        changePasswordSection.style.display = 'block';
        changeAvatarSection.style.display = 'none';
        changeContactSection.style.display = 'none';
        breadcrumbPath.textContent = '修改密碼';
      });
      
            // 顯示修改聯絡資訊
      btnChangeContact.addEventListener('click', function () {
        personalInfoSection.style.display = 'none';
        changePasswordSection.style.display = 'none';
        changeAvatarSection.style.display = 'none';
        changeContactSection.style.display = 'block';
        breadcrumbPath.textContent = '修改聯絡資訊';
      });
      

      // 顯示修改頭像區域
      btnChangeAvatar.addEventListener('click', function () {
        personalInfoSection.style.display = 'none';
        changePasswordSection.style.display = 'none';
        changeAvatarSection.style.display = 'block';
        changeContactSection.style.display = 'none';
        breadcrumbPath.textContent = '更新頭像';

        getAvatar();
      });

      // 提交修改密碼請求
      changePasswordForm.addEventListener('submit', function (event) {
        event.preventDefault(); // 阻止表單的預設提交行為

        const currentPassword = currentPasswordInput.value;
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;

        // 驗證新密碼是否一致
        if (newPassword !== confirmPassword) {
          alert('新密碼與確認密碼不一致');
          return;
        }

        const token = localStorage.getItem('token'); // 從 localStorage 取得 token

        if (token) {
          // 使用 URLSearchParams 構建請求參數
          const params = new URLSearchParams();
          params.append('oldPassword', currentPassword);
          params.append('newPassword', newPassword);
          params.append('confirmPassword', confirmPassword);

          // 使用 axios 發送帶有 URL 編碼的請求
          axios.post('/SpanTasty/member/updatePassword', params, {
            headers: {
              'Authorization': `${token}`,
              'Content-Type': 'application/x-www-form-urlencoded' // 明確指定編碼格式
            }
          })
            .then(response => {
              if (response.data.success) {
                alert('密碼修改成功');
                // 清空輸入欄位
                currentPasswordInput.value = '';
                newPasswordInput.value = '';
                confirmPasswordInput.value = '';
              } else {
                alert('密碼修改失敗：' + response.data.message);
              }
            })
            .catch(error => {
              console.error('修改密碼過程中發生錯誤:', error.response ? error.response.data : error);
              alert('修改密碼過程中發生錯誤');
            });
        } else {
          alert('請先登入');
          window.location.href = '/SpanTasty/StarCups';
        }
      });
      
      // 更新聯絡方式
    updateContactButton.addEventListener('click', function () {
      const phone = contactPhoneInput.value;
      const email = contactEmailInput.value;
      const address = contactAddressInput.value;

      const params = new URLSearchParams();
      if (phone) params.append('phone', phone);
      if (email) params.append('email', email);
      if (address) params.append('address', address);

      axios.post('/SpanTasty/member/updateContactInfo', params, {
        headers: {
          'Authorization': `${token}`,
          'Content-Type': 'application/x-www-form-urlencoded',
        }
      })
      .then(response => {
        if (response.data.success) {
          alert('聯絡資訊更新成功');
        } else {
          alert('聯絡資訊更新失敗：' + response.data.message);
        }
      })
      .catch(error => {
        console.error('更新聯絡資訊過程中發生錯誤:', error.response ? error.response.data : error);
        alert('更新聯絡資訊過程中發生錯誤');
      });
    });


      // 預覽頭像
      avatarInput.addEventListener('change', function () {
        const file = avatarInput.files[0];

        if (file && file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = function (e) {
            // 使用 changeCurrentAvatar 來預覽圖片
            changeCurrentAvatar.src = e.target.result;
            confirmAvatarButton.style.display = 'inline-block';
          };
          reader.readAsDataURL(file);
        } else {
          alert('請選擇有效的圖片文件');
        }
      });

      // 更新頭像
      confirmAvatarButton.addEventListener('click', function () {
        const file = avatarInput.files[0];
        const token = localStorage.getItem('token');

        if (file && token) {
          const formData = new FormData();
          formData.append('avatar', file);

          axios.post('/SpanTasty/member/updateAvatar', formData, {
            headers: {
              'Authorization': `${token}`,
              'Content-Type': 'multipart/form-data',
            }
          })
            .then(response => {
              if (response.data.success) {
                alert('頭像已更新');
                confirmAvatarButton.style.display = 'none';
                const imageUrl = URL.createObjectURL(file);
                personalCurrentAvatar.src = imageUrl;
                changeCurrentAvatar.src = imageUrl;
              } else {
                alert('更新圖片失敗');
              }
            })
            .catch(error => {
              console.error('Error:', error);
              alert('上傳過程中發生錯誤');
            });
        } else {
          alert('請選擇一張圖片並確保已登入');
        }
      });

      // 移除頭像
      removeAvatarButton.addEventListener('click', function () {
        const token = localStorage.getItem('token');

        if (token) {
          axios.post('/SpanTasty/member/removeAvatar', {}, {
            headers: {
              'Authorization': `${token}`,
            }
          })
            .then(response => {
              if (response.data.success) {
                alert('頭像已成功移除');
                personalCurrentAvatar.src = '/SpanTasty/starcups/images/account/defaultUser.jpeg';
                changeCurrentAvatar.src = '/SpanTasty/starcups/images/account/defaultUser.jpeg';
              } else {
                alert('移除頭像失敗，請稍後再試');
              }
            })
            .catch(error => {
              console.error('Error:', error);
              alert('移除頭像過程中發生錯誤');
            });
        }
      });

      // 獲取會員頭像
      function getAvatar() {
        const token = localStorage.getItem('token'); // 從 localStorage 取得 token

        if (token) {
          axios.get('/SpanTasty/member/getAvatar', {
            headers: {
              'Authorization': `${token}`
            }
          })
            .then(response => {
              if (response.data.success && response.data.data) {
                const base64Avatar = response.data.data; // 從響應中獲取 Base64 的圖片數據
                // 更新「個人資訊」中的頭像
                personalCurrentAvatar.src = `data:image/jpeg;base64,${base64Avatar}`;
                // 更新「修改圖片」區域中的頭像
                changeCurrentAvatar.src = `data:image/jpeg;base64,${base64Avatar}`;
              } else {
                // 如果沒有頭像，使用預設圖片
                personalCurrentAvatar.src = '/SpanTasty/starcups/images/account/defaultUser.jpeg';
                changeCurrentAvatar.src = '/SpanTasty/starcups/images/account/defaultUser.jpeg';
              }
            })
            .catch(error => {
              console.error('Error:', error);
              alert('獲取頭像過程中發生錯誤');
            });
        } else {
          window.location.href = '/SpanTasty/StarCups';
        }
      }
      // 獲取個人資訊
      function getProfile() {
        const token = localStorage.getItem('token');

        if (token) {
          axios.get('/SpanTasty/member/profile', {
            headers: {
              'Authorization': `${token}`
            }
          })
            .then(response => {
              if (response.data.success) {
                const member = response.data.data;
                memberName.textContent = member.memberName;
                memberEmail.textContent = member.email;
                memberPhone.textContent = member.phone;
                memberAddress.textContent = member.address;
                registerDate.textContent = member.registerDate;
                birthday.textContent = member.birthday;
                lastLogin.textContent = member.formattedLoginDate;
              } else {
                alert('無法獲取個人資訊');
              }
            })
            .catch(error => {
              console.error('獲取個人資訊過程中發生錯誤:', error);
            });
        } else {
          alert('請先登入');
          window.location.href = '/SpanTasty/StarCups';
        }
      }
    });
    
        document.addEventListener('DOMContentLoaded', function () {
      const memberCenterTitle = document.querySelector('.breadcrumbs-custom-title');
      const breadcrumbPath = document.querySelector('.breadcrumbs-custom-path .active');

      // 對每個連結添加點擊事件
      document.getElementById('member-info-link').addEventListener('click', function () {
        // 更新標題與麵包屑
        memberCenterTitle.textContent = '個人資訊';
        breadcrumbPath.textContent = '個人資訊';
      });

      document.getElementById('change-password-link').addEventListener('click', function () {
        // 更新標題與麵包屑
        memberCenterTitle.textContent = '修改密碼';
        breadcrumbPath.textContent = '修改密碼';
      });

      document.getElementById('change-avatar-link').addEventListener('click', function () {
        // 更新標題與麵包屑
        memberCenterTitle.textContent = '更換頭像';
        breadcrumbPath.textContent = '更換頭像';
      });
      
      document.getElementById('change-contact-link').addEventListener('click', function () {
        // 更新標題與麵包屑
        memberCenterTitle.textContent = '修改聯絡資訊';
        breadcrumbPath.textContent = '修改聯絡資訊';
      });
    });
    
  </script>

</body>

</html>