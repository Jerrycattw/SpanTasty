<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org/">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>會員中心</title>
  <link rel="stylesheet" href="/SpanTasty/starcups/css/bootstrap.css">
  <link rel="stylesheet" href="/SpanTasty/starcups/css/fonts.css">
  <link rel="stylesheet" href="/SpanTasty/starcups/css/style.css">
  <style>
    .user-avatar {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 275px;
      height: 275px;
      background-color: #f0f0f0;
      border-radius: 50%;
      border: 2px solid #ccc;
      overflow: hidden;
      margin: 0 auto;
    }

    .user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .personal-info-table {
      width: 100%;
      margin: 20px auto;
      font-size: 18px;
    }

    .personal-info-table th,
    .personal-info-table td {
      padding: 10px;
      text-align: left;
    }

    .personal-info-table th {
      width: 40%;
      font-weight: bold;
      text-align: right;
    }

    .card-body {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .button-custom {
      border: none;
      color: white;
      transition: background-color 0.3s ease, transform 0.2s ease;
      width: 80%;
      margin-bottom: 10px;
      background-color: #efc4a3;
    }

    .button-custom:hover {
      background-color: #efc4a3;
      transform: scale(1.05);
    }

    .button-custom:active {
      background-color: #b3876a;
      transform: scale(0.98);
    }

    .button-red {
      background-color: #dc3545;
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }

    .button-red:hover {
      background-color: #c82333;
      transform: scale(1.05);
    }

    .button-red:active {
      background-color: #bd2130;
      transform: scale(0.98);
    }

    .button-container {
      display: flex;
      justify-content: space-between;
      /* 按鈕兩端對齊，並在中間留出空間 */
      width: 100%;
    }



    .mleft10 {
      margin-left: 10px;
    }

    .mb10 {
      margin-bottom: 10px;
    }

    .post-sidebar-item {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 5px;
      margin-bottom: 20px;
    }

    .list-categories li {
      list-style: none;
      margin-bottom: 8px;
    }

    .list-categories a {
      color: #007bff;
      text-decoration: none;
      transition: color 0.3s ease;
    }

    .list-categories a:hover {
      color: #0056b3;
    }

    .bcf7 {
      background-color: #F7F7F7;
    }

    #edit-member-name,
    #edit-birthday,
    #edit-memberPhone,
    #edit-memberAddress,
    #edit-member-email {
      width: 120%;
      /* 設置輸入框寬度為父元素的 100% */
      max-width: 600px;
      /* 設置一個合理的最大寬度 */
    }
  </style>
</head>

<body>
  <div th:replace="~{/starcups/display/navbar}"></div>
	
  <!-- 記得修改 -->
  <section class="section breadcrumbs-custom-inset">
    <div class="breadcrumbs-custom context-dark">
      <div class="container">
        <h2 class="breadcrumbs-custom-title">會員中心</h2>
        <ul class="breadcrumbs-custom-path">
          <li><a href="/SpanTasty/StarCups">Home</a></li>
          <li><a href="/SpanTasty/StarCups/memberCenter">會員中心</a></li>
          <li class="active">帳戶管理</li>
        </ul>
      </div>
      <div class="box-position novi-bg novi-bg-img" style="background-image: url(images/bg-breadcrumbs.jpg);"></div>
    </div>
  </section>

  <section class="section novi-bg novi-bg-img section-xl bg-default text-md-start">
    <div class="container">
      <div class="row row-50 justify-content-md-center">
      	
      	<!-- 左側區域 -->
        <div th:replace="~{/starcups/display/memberCenterSidebar}"></div>
        

        <!-- 右側區域 -->
        <div class="col-md-9">

          <!-- 個人資訊 -->
          <div id="personal-info" class="content-section">
            <div class="card mx-auto">
              <div class="card-body bcf7">
                <h4 class="text-spacing-50 text-center mb10">個人資訊</h4>
                <div class="user-avatar mb-4" id="personal-preview-avatar">
                  <img id="personal-current-avatar" src="/SpanTasty/starcups/images/account/defaultUser.jpeg" alt="頭像"
                    class="rounded-circle border">
                </div>
                <div class="personal-info-details">
                  <table class="personal-info-table">
                    <tr>
                      <th>姓名：</th>
                      <td><span id="member-name">未設定</span></td>
                    </tr>
                    <tr>
                      <th>生日：</th>
                      <td><span id="birthday">未設定</span></td>
                    </tr>
                    <tr>
                      <th>電話：</th>
                      <td><span id="memberPhone">未設定</span></td>
                    </tr>
                    <tr>
                      <th>聯絡地址：</th>
                      <td><span id="memberAddress">未設定</span></td>
                    </tr>
                    <tr>
                      <th>信箱：</th>
                      <td><span id="member-email">未設定</span></td>
                    </tr>
                    <tr>
                      <th>註冊日期：</th>
                      <td><span id="register-date">未設定</span></td>
                    </tr>
                    <tr>
                      <th>最近登入：</th>
                      <td><span id="last-login">未設定</span></td>
                    </tr>
                  </table>
                </div>
                <button class="button button-secondary mb10" id="edit-personal-info-button">編輯</button>
              </div>
            </div>
          </div>
          <!-- 個人資訊 -->

          <!-- 編輯個人資訊區塊 -->
          <div id="edit-personal-info" class="content-section" style="display: none;">
            <div class="card mx-auto">
              <div class="card-body bcf7">
                <h4 class="text-spacing-50 text-center mb10">編輯個人資訊</h4>
                <div class="user-avatar mb-4" id="edit-preview-avatar">
                  <img id="edit-current-avatar" src="/SpanTasty/starcups/images/account/defaultUser.jpeg" alt="頭像"
                    class="rounded-circle border">
                </div>
                <div class="personal-info-details">
                  <table class="personal-info-table">
                    <tr>
                      <th>姓名：</th>
                      <td><input type="text" id="edit-member-name" class="form-control" readonly></td>
                    </tr>
                    <tr>
                      <th>*生日：</th>
                      <td><input type="date" id="edit-birthday" class="form-control"></td>
                    </tr>
                    <tr>
                      <th>*電話：</th>
                      <td><input type="text" id="edit-memberPhone" class="form-control"></td>
                    </tr>
                    <tr>
                      <th>*聯絡地址：</th>
                      <td><input type="text" id="edit-memberAddress" class="form-control"></td>
                    </tr>
                    <tr>
                      <th>信箱：</th>
                      <td><input type="email" id="edit-member-email" class="form-control" readonly></td>
                    </tr>
                  </table>
                </div>
                <div class="button-container d-flex justify-content-around">
                  <button class="button" id="save-edit-info-button" style="display: none;">儲存</button>
                  <button class="button" id="save-edit-info-button2">儲存</button>
                  <button class="button" id="cancel-edit-info-button">取消</button>
                </div>
              </div>
            </div>
          </div>
          <!-- 編輯個人資訊區塊 -->

          <!-- 修改密碼區塊 -->
          <div id="change-password" class="content-section" style="display:none;">
            <h4 class="text-spacing-50 text-center mb10">修改密碼</h4>
            <div class="card mx-auto">
              <div class="card-body bcf7">
                <form class="bcf7">
                  <div class="form-group">
                    <label for="current-password">原密碼</label>
                    <input class="form-control" id="current-password" type="password" required>
                  </div>
                  <div class="form-group">
                    <label for="new-password">新密碼</label>
                    <input class="form-control" id="new-password" type="password" required>
                  </div>
                  <div class="form-group">
                    <label for="confirm-password">確認新密碼</label>
                    <input class="form-control" id="confirm-password" type="password" required>
                  </div>
                  <button class="button button-block button-secondary" type="submit">修改密碼</button>
                </form>
              </div>
            </div>
          </div>
          <!-- 修改密碼區塊 -->

          <!-- 修改頭像區塊 -->
          <div id="change-avatar" class="content-section" style="display:none;">
            <h4 class="text-spacing-50 text-center mb10">修改頭像</h4>
            <div class="card">
              <div class="card-body text-center bcf7">
                <div class="user-avatar mb-3" id="change-preview-avatar">
                  <img id="change-current-avatar" src="/SpanTasty/starcups/images/account/defaultUser.jpeg" alt="頭像"
                    width="300" height="300">
                </div>
                <button class="button button-secondary button-custom" id="confirm-avatar"
                  style="display:none;">保存</button>
                <div class="form-group">
                  <div class="button-container">
                    <input type="file" id="avatar-input" class="form-control-file" accept="image/*"
                      style="display: none;">
                    <button class="button button-green mleft10" id="avatar-upload-button">選擇圖片</button>
                    <button class="button button-red mleft10" id="remove-avatar">移除頭像</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- 修改頭像區塊 -->


        </div>
      </div>
    </div>
  </section>

  <div th:replace="~{starcups/display/footer}"></div>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="/SpanTasty/starcups/js/core.min.js"></script>
  <script src="/SpanTasty/starcups/js/script.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const token = localStorage.getItem('token');

      if (!token) {
        Swal.fire('錯誤', '請先登入', 'warning');
        window.location.href = '/SpanTasty/StarCups';
      } else {
        getProfile();
        getAvatar();
      }

      // 設置表單提交事件
      document.querySelector('#change-password form').addEventListener('submit', function (event) {
        event.preventDefault();  // 防止表單默認提交行為

        const oldPassword = document.getElementById('current-password').value;
        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;

        // 簡單檢查新密碼和確認密碼是否一致
        if (newPassword !== confirmPassword) {
          Swal.fire('錯誤', '新密碼與確認密碼不一致', 'error');
          return;
        }

        // 建立 URLSearchParams 來封裝請求參數
        const params = new URLSearchParams();
        params.append('oldPassword', oldPassword);
        params.append('newPassword', newPassword);
        params.append('confirmPassword', confirmPassword);

        Swal.fire({
          title: '確認修改密碼？',
          text: '請確認你要修改的密碼。',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: '是的，修改！',
          cancelButtonText: '取消'
        }).then((result) => {
          if (result.isConfirmed) {
            // 發送修改密碼的請求
            axios.post('/SpanTasty/member/updatePassword', params, {
              headers: {
                'Authorization': `${token}`,
                'Content-Type': 'application/x-www-form-urlencoded'
              }
            })
              .then(response => {
                if (response.data.success) {
                  Swal.fire(
                    '修改成功!',
                    '你的密碼已修改成功。',
                    'success'
                  ).then(() => {
                    // 可選：重定向到某個頁面
                    window.location.href = '/SpanTasty/StarCups/memberCenter';
                  });
                } else {
                  Swal.fire('修改失敗', response.data.message, 'error');
                }
              })
              .catch(error => {
                console.error('修改密碼時發生錯誤:', error);
                Swal.fire('錯誤', '修改密碼過程中發生錯誤，請稍後再試。', 'error');
              });
          }
        });
      });

      //編輯按鈕的事件
      document.getElementById('edit-personal-info-button').addEventListener('click', function () {
        // 隱藏個人資訊區塊，顯示編輯區塊
        document.getElementById('personal-info').style.display = 'none';
        document.getElementById('edit-personal-info').style.display = 'block';

        document.getElementById('edit-member-name').value = document.getElementById('member-name').textContent;
        document.getElementById('edit-birthday').value = document.getElementById('birthday').textContent;
        document.getElementById('edit-memberPhone').value = document.getElementById('memberPhone').textContent;
        document.getElementById('edit-memberAddress').value = document.getElementById('memberAddress').textContent;
        document.getElementById('edit-member-email').value = document.getElementById('member-email').textContent;

      });

      // 儲存變更按鈕的事件
      document.getElementById('save-edit-info-button2').addEventListener('click', function () {
        const token = localStorage.getItem('token');
        if (!token) {
          Swal.fire({
            icon: 'error',
            title: '錯誤',
            text: '請先登入',
          }).then(() => {
            window.location.href = '/SpanTasty/StarCups';
          });
          return;
        }

        const birthday = document.getElementById('edit-birthday').value;
        const phone = document.getElementById('edit-memberPhone').value;
        const address = document.getElementById('edit-memberAddress').value;

        // 建立 URLSearchParams 來封裝請求參數
        const params = new URLSearchParams();
        if (birthday) params.append('birthday', birthday);
        if (phone) params.append('phone', phone);
        if (address) params.append('address', address);

        Swal.fire({
          title: '確認變更資料？',
          text: '你確定要保存變更嗎？',
          icon: 'question',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: '是的，保存！',
          cancelButtonText: '取消'
        }).then((result) => {
          if (result.isConfirmed) {
            // 發送修改會員資訊的請求
            axios.post('/SpanTasty/member/updateMemberInfo', params, {
              headers: {
                'Authorization': `${token}`,
                'Content-Type': 'application/x-www-form-urlencoded'
              }
            })
              .then(response => {
                if (response.data.success) {
                  // 更新顯示的個人資訊
                  document.getElementById('birthday').textContent = birthday;
                  document.getElementById('memberPhone').textContent = phone;
                  document.getElementById('memberAddress').textContent = address;

                  Swal.fire(
                    '更新成功!',
                    '資料已更新成功。',
                    'success'
                  ).then(() => {
                    // 顯示個人資訊，隱藏編輯區塊
                    document.getElementById('personal-info').style.display = 'block';
                    document.getElementById('edit-personal-info').style.display = 'none';
                  });
                } else {
                  Swal.fire('更新失敗', '資料更新失敗：' + response.data.message, 'error');
                }
              })
              .catch(error => {
                console.error('更新會員資訊時發生錯誤:', error);
                Swal.fire('錯誤', '更新會員資訊過程中發生錯誤', 'error');
              });
          }
        });
      });



      // 取消按鈕的事件
      document.getElementById('cancel-edit-info-button').addEventListener('click', function () {
        // 隱藏編輯區塊，顯示個人資訊區塊
        document.getElementById('personal-info').style.display = 'block';
        document.getElementById('edit-personal-info').style.display = 'none';
      });

      //更新個人訊息
      document.getElementById('save-edit-info-button2').addEventListener('click', function () {
        const token = localStorage.getItem('token');
        if (!token) {
          alert('請先登入');
          window.location.href = '/SpanTasty/StarCups';
          return;
        }

        const name = document.getElementById('edit-member-name').value;
        const birthday = document.getElementById('edit-birthday').value;
        const phone = document.getElementById('edit-member-phone').value;
        const address = document.getElementById('edit-member-address').value;

        const params = new URLSearchParams();
        params.append('memberName', name);
        params.append('birthday', birthday);
        params.append('phone', phone);
        params.append('address', address);

        axios.post('/SpanTasty/member/updateProfile', params, {
          headers: {
            'Authorization': `${token}`,
            'Content-Type': 'application/x-www-form-urlencoded',
          }
        })
          .then(response => {
            if (response.data.success) {
              alert('個人資訊更新成功');
              // 更新顯示的個人資訊
              document.getElementById('member-name').textContent = name;
              document.getElementById('birthday').textContent = birthday;
              document.getElementById('memberPhone').textContent = phone;
              document.getElementById('memberAddress').textContent = address;

              // 隱藏編輯表單並顯示更新後的資訊
              document.getElementById('edit-personal-info').style.display = 'none';
              document.querySelector('.personal-info-details').style.display = 'block';
            } else {
              alert('個人資訊更新失敗：' + response.data.message);
            }
          })
          .catch(error => {
            console.error('更新個人資訊過程中發生錯誤:', error);
            alert('更新個人資訊過程中發生錯誤');
          });
      });

      document.querySelectorAll('.button-custom').forEach(button => {
        button.addEventListener('click', function () {
          const sectionId = this.id.replace('btn-', '');
          getAvatar();
          showSection(sectionId);
        });
      });

      function showSection(sectionId) {
        document.querySelectorAll('.content-section').forEach(section => section.style.display = 'none');
        document.getElementById(sectionId).style.display = 'block';
      }
    });

    //確認更改頭像
    document.getElementById('avatar-upload-button').addEventListener('click', function (event) {
      event.preventDefault();
      document.getElementById('avatar-input').click();
    });

    //預覽頭像
    document.getElementById('avatar-input').addEventListener('change', function () {
      const file = this.files[0];
      if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function (e) {
          document.getElementById('change-current-avatar').src = e.target.result;
          document.getElementById('confirm-avatar').style.display = 'inline-block';
        };
        reader.readAsDataURL(file);
      } else {
        alert('請選擇有效的圖片檔案');
      }
    });

    //更新頭像
    document.getElementById('confirm-avatar').addEventListener('click', function () {
      const file = document.getElementById('avatar-input').files[0];
      const token = localStorage.getItem('token');

      if (file && token) {
        const formData = new FormData();
        formData.append('avatar', file);

        Swal.fire({
          title: '你確定要更新頭像嗎？',
          text: "這將會更換你的頭像！",
          icon: 'info',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: '是的，更新！',
          cancelButtonText: '取消'
        }).then((result) => {
          if (result.isConfirmed) {
            axios.post('/SpanTasty/member/updateAvatar', formData, {
              headers: {
                'Authorization': `${token}`,
                'Content-Type': 'multipart/form-data',
              }
            })
              .then(response => {
                if (response.data.success) {
                  Swal.fire(
                    '更新成功!',
                    '你的頭像已成功更新。',
                    'success'
                  ).then(() => {
                    location.reload();  // 重新整理頁面
                  });

                } else {
                  Swal.fire('更新失敗', '更新頭像過程中出現問題，請稍後再試。', 'error');
                }
              })
              .catch(error => handleError(error, '上傳過程中發生錯誤，請稍後再試'));
          }
        });
      } else {
        Swal.fire('錯誤', '請選擇一張圖片並確保已登入。', 'warning');
      }
    });

    //移除頭像
    document.getElementById('remove-avatar').addEventListener('click', function () {
      const token = localStorage.getItem('token');

      if (token) {

        Swal.fire({
          title: '你確定要移除頭像嗎？',
          text: "移除後將無法恢復！",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: '是的，移除它！',
          cancelButtonText: '取消'
        }).then((result) => {
          if (result.isConfirmed) {
            axios.post('/SpanTasty/member/removeAvatar', {}, {
              headers: {
                'Authorization': `${token}`,
              }
            })
              .then(response => {
                if (response.data.success) {
                  Swal.fire(
                    '已移除!',
                    '你的頭像已成功移除。',
                    'success')
                    .then(() => {
                      location.reload();  // 重新整理頁面
                    });
                } else {
                  Swal.fire('移除失敗', '請稍後再試', 'error');
                }
              })
              .catch(error => handleError(error, '移除過程中發生錯誤'));
          }
        });
      }
    });

    //獲取頭像
    function getAvatar() {
      const token = localStorage.getItem('token');

      if (token) {
        axios.get('/SpanTasty/member/getAvatar', {
          headers: {
            'Authorization': `${token}`
          }
        })
          .then(response => {
            if (response.data.success && response.data.data) {
              const base64Avatar = response.data.data;
              document.getElementById('personal-current-avatar').src = `data:image/jpeg;base64,${base64Avatar}`;
              document.getElementById('change-current-avatar').src = `data:image/jpeg;base64,${base64Avatar}`;
              document.getElementById('edit-current-avatar').src = `data:image/jpeg;base64,${base64Avatar}`;
            } else {
              document.getElementById('personal-current-avatar').src = '/SpanTasty/starcups/images/account/defaultUser.jpeg';
              document.getElementById('change-current-avatar').src = '/SpanTasty/starcups/images/account/defaultUser.jpeg';
              document.getElementById('edit-current-avatar').src = '/SpanTasty/starcups/images/account/defaultUser.jpeg';
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('獲取頭像過程中發生錯誤');
          });
      } else {
        window.location.href = '/SpanTasty/StarCups';
      }
    }

    //獲取個人訊息
    function getProfile() {
      const token = localStorage.getItem('token');

      if (token) {
        axios.get('/SpanTasty/member/profile', {
          headers: {
            'Authorization': `${token}`
          }
        })
          .then(response => {
            if (response.data.success) {
              const member = response.data.data;
              document.getElementById('member-name').textContent = member.memberName;
              document.getElementById('member-email').textContent = member.email;
              document.getElementById('memberPhone').textContent = member.phone;
              document.getElementById('memberAddress').textContent = member.address;
              document.getElementById('register-date').textContent = member.registerDate;
              document.getElementById('birthday').textContent = member.birthday;
              document.getElementById('last-login').textContent = member.formattedLoginDate;
            } else {
              alert('無法獲取個人資訊');
            }
          })
          .catch(error => {
            console.error('獲取個人資訊過程中發生錯誤:', error);
          });
      } else {
        alert('請先登入');
        window.location.href = '/SpanTasty/StarCups';
      }
    }

    function handleError(error, customMessage = '請稍後再試') {
      console.error('Error:', error);
      Swal.fire('錯誤', customMessage, 'error');
    }
  </script>
</body>

</html>