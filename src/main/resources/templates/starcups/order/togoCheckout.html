<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org/" class="wide wow-animation" lang="en">

<head>
  <title>Checkout</title>
  <meta name="format-detection" content="telephone=no">
  <meta name="viewport"
    content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta charset="utf-8">
  <link rel="icon" href="images/favicon.ico" type="image/x-icon">
  <!-- Stylesheets-->
  <!-- 更改樣式 -->
  <link rel="stylesheet" type="text/css"
    href="https://fonts.googleapis.com/css?family=Poppins:400,500%7CTeko:300,400,500%7CMaven+Pro:500">
  <link rel="stylesheet" href="/SpanTasty/starcups/css/bootstrap.css">
  <link rel="stylesheet" href="/SpanTasty/starcups/css/fonts.css">
  <link rel="stylesheet" href="/SpanTasty/starcups/css/style.css">
  <style>
    .ie-panel {
      display: none;
      background: #212121;
      padding: 10px 0;
      box-shadow: 3px 3px 5px 0 rgba(0, 0, 0, .3);
      clear: both;
      text-align: center;
      position: relative;
      z-index: 1;
    }

    html.ie-10 .ie-panel,
    html.lt-ie-10 .ie-panel {
      display: block;
    }
  </style>
</head>

<body>
  <!-- navbar  th:replace=-->
  <div th:replace="~{starcups/display/navbar}"></div>
  <div class="ie-panel"><a href="http://windows.microsoft.com/en-US/internet-explorer/"><img
        src="images/ie8-panel/warning_bar_0000_us.jpg" height="42" width="820"
        alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today."></a>
  </div>
  <div class="preloader">
    <div class="preloader-body">
      <div class="cssload-container"><span></span><span></span><span></span><span></span>
      </div>
    </div>
  </div>
  <div class="page">
    <!-- Page Header-->
    <header class="section page-header">
      <!-- RD Navbar-->

    </header>
    <!-- Breadcrumbs -->
    <section class="section breadcrumbs-custom-inset">
      <div class="breadcrumbs-custom context-dark">
        <div class="container">
          <h2 class="breadcrumbs-custom-title">Checkout</h2>
          <ul class="breadcrumbs-custom-path">
            <li><a href="/SpanTasty/StarCups">Home</a></li>
            <li><a href="/SpanTasty/StarCups/order">Order Online</a></li>
            <li class="active">Checkout</li>
          </ul>
        </div>
        <div class="box-position novi-bg novi-bg-img" style="background-image: url(images/bg-breadcrumbs.jpg);"></div>
      </div>
    </section>
    <!-- Section checkout form-->
    <!-- <section class="section novi-bg novi-bg-img section-xl bg-default text-md-start"> -->
    <section>
      <div class="container">
        <!-- 刪除帳單地址填寫框 -->
        <div class="row row-50 justify-content-center">
        </div>
      </div>
    </section>
    <!-- Shopping Cart-->
    <section class="section novi-bg novi-bg-img section-xl bg-default text-md-start">
      <div class="container">
        <div class="group-xmd group-middle">
          <h4 class="text-spacing-50">Your shopping cart</h4>
          <div style="display: flex; align-items: center; margin-left: auto; margin-bottom: 10px;">
            <h6 class="text-gray-500" style="margin-right: 10px;">Total</h6>
            <h3 class="cart-product-price"><sup>$</sup>524</h3>
          </div>
        </div>
        <!-- shopping-cart-->
        <div class="table-custom-responsive">
          <table class="table-custom table-cart">
            <thead>
              <tr>
                <th>Product name</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Total</th>
              </tr>
            </thead>
            <!-- 購物車資訊 -->
            <tbody>
              <tr>
                <td>
                  <!-- 圖片 -->
                  <div class="table-cart-figure" style="margin-right: 30px;">
                    <img src="images/product-mini-7-146x132.png" alt="" width="146" height="132" />
                  </div>
                  <!-- 名稱 -->
                  <div class="table-cart-link">Burdur Pearl</div>
                </td>
                <!-- 價格 -->
                <td>$289</td>
                <!-- 數量 -->
                <td>1</td>
                <!-- 單項總價 -->
                <td>$235</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Section payment-->
    <section class="section novi-bg novi-bg-img section-xl bg-default text-md-start">
      <div class="container">
        <div class="row row-50 justify-content-center">
          <!-- 取餐資訊 -->
          <div class="col-md-10 col-lg-6">
            <h4 class="text-spacing-50">Pickup Location</h4>
            <div class="row row-14 row-fix gutters-14" style="margin-top: 25px;">
              <!--Select 2-->

              <div class="col-sm-6">
                <!-- <div style="display: flex; gap: 10px;"> -->
                <select class="form-input select-filter" data-minimum-results-for-search="Infinity"
                  data-constraints="@Required" id="citySelect" onchange="fetchTowns()">
                  <option value="">選擇縣市</option>
                </select>
              </div>
              <div class="col-sm-6">
                <select class="form-input select-filter" data-minimum-results-for-search="Infinity"
                  data-constraints="@Required" id="townSelect" disabled onchange="fetchRestaurants()">
                  <option value="">選擇鄉鎮</option>
                </select>
                <!-- </div> -->
              </div>
              <div class="col-sm-12">
                <select class="form-input select-filter" data-minimum-results-for-search="Infinity"
                  data-constraints="@Required" id="restaurantSelect" disabled>
                  <option value="">選擇餐廳</option>
                </select>
              </div>
            </div>
            <h4 class="text-spacing-50" style="margin-top: 30px;">Pickup Information</h4>
            <form class="rd-form rd-mailform">
              <div class="row row-14 row-fix gutters-14">
                <div class="col-sm-6">
                  <div class="form-wrap">
                    <input class="form-input" id="tgName" type="text" name="tgName" data-constraints="@Required" />
                    <label class="form-label" for="tgName">Name</label>
                  </div>
                </div>
                <!-- <div class="col-sm-6">
                  <div class="form-wrap">
                    <input class="form-input" id="checkout-last-name-1" type="text" name="name"
                      data-constraints="@Required" />
                    <label class="form-label" for="checkout-last-name-1">Last Name</label>
                  </div>
                </div> -->
                <!-- <div class="col-sm-6">
                  <div class="form-wrap">
                    <input class="form-input" id="checkout-email-1" type="email" name="email"
                      data-constraints="@Email @Required" />
                    <label class="form-label" for="checkout-email-1">E-Mail</label>
                  </div>
                </div> -->
                <div class="col-sm-6">
                  <div class="form-wrap">
                    <input class="form-input" id="tgPhone" type="text" name="tgPhone" data-constraints="@Numeric" />
                    <label class="form-label" for="tgPhone">Phone</label>
                  </div>
                </div>
                <div class="col-sm-12">
                  <div class="form-wrap">
                    <label class="form-label" for="togoMemo">Memo</label>
                    <textarea class="form-input" name="togoMemo" id="togoMemo"></textarea>
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="col-md-10 col-lg-6">
            <h4 class="text-spacing-50">Payment methods</h4>
            <div class="box-radio">
              <div class="radio-panel">
                <label class="radio-inline active">
                  <input name="input-group-radio" value="checkbox-1" type="radio" checked readonly>現金支付
                </label>
                <div class="radio-panel-content">
                  <p>僅供門市現金支付</p>
                </div>
              </div>
              <!-- <div class="radio-panel">
                <label class="radio-inline">
                  <input name="input-group-radio" value="checkbox-1" type="radio">PayPal
                </label>
                <div class="radio-panel-content">
                  <p>Pay via PayPal; you can pay with your credit card if you don’t have a PayPal account.</p>
                </div>
              </div>
              <div class="radio-panel">
                <label class="radio-inline">
                  <input name="input-group-radio" value="checkbox-1" type="radio">Cheque Payment
                </label>
                <div class="radio-panel-content">
                  <p>Please send a check to Store Name, Store Street, Store Town, Store State / County, Store Postcode.</p>
                </div>
              </div> -->
            </div>
            <h4 class="text-spacing-50" style="margin-top: 30px;">Cart totals</h4>
            <div class="table-custom-responsive">
              <table class="table-custom table-custom-primary table-checkout">
                <tbody>
                  <tr>
                    <td>Cart Subtotal</td>
                    <td id="subtotal">$524</td>
                  </tr>
                  <tr>
                    <td>Discount</td>
                    <td id="discount"></td>
                  </tr>
                  <tr>
                    <td>Total</td>
                    <td id="total">$524</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <!-- 訂單送出 -->
        <div class="button-wrap text-center">
          <button class="button button-secondary button-pipaluk" id="submitTogoBtn" type="submit">Proceed to
            checkout</button>
        </div>
      </div>
    </section>

    <!-- Page Footer-->
    <footer class="section footer-variant-2 footer-modern context-dark novi-bg novi-bg-img">
    </footer>
  </div>
  <!-- Global Mailform Output-->
  <div class="snackbars" id="form-output-global"></div>
  <!-- footer th:replace -->
  <div th:replace="~{starcups/display/footer}"></div>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      loadCartIntoTable(); // 頁面加載時調用



      //訂單提交
      document.getElementById("submitTogoBtn").addEventListener("click", function () {
        getProfile();
        const cart = JSON.parse(localStorage.getItem('cart')) || [];
        // 如果購物車是空的，則提醒用戶
        if (cart.length === 0) {
          alert("您的購物車是空的，無法進行結帳！");
          return;
        }
        createTogo();

      })

    })

    function createTogo() {
      // 從 localStorage 中獲取 memberId
      const memberId = localStorage.getItem('memberId');
      const togoMemo = document.getElementById("togoMemo").value;
      const restaurantId = document.getElementById("restaurantSelect").value;
      const tgName = document.getElementById("tgName").value;
      const tgPhone = document.getElementById("tgPhone").value;

      if (!restaurantId) {
        alert("請選擇餐廳");
        return;
      }

      // 建立訂單資料物件
      const togoData = {
        memberId,
        tgPhone,
        tgName,
        restaurantId,
        togoMemo,
      };
      // 發送 axios 請求來建立訂單
      axios.post('http://localhost:8080/SpanTasty/order/togo', togoData)
        .then(response => {
          if (response.data) {
            const togoId = response.data.togoId; // 獲取新建訂單的 ID
            console.log('togoId ' + togoId)
            // 接著建立訂單明細
            createOrderItems(togoId);
          } else {
            console.log('無法建立訂單');
          }
        })
        .catch(error => {
          console.error('建立訂單過程中發生錯誤:', error);
        });
    }

    function createOrderItems(togoId) {
      // 取得購物車中的資料
      const cart = JSON.parse(localStorage.getItem('cart')) || [];
      const newTogoItems = cart.map(item => {
        return {
          togoItemId: {
            togoId: togoId,
            foodId: item.foodId
          },
          amount: item.quantity,
          togoItemPrice: item.foodPrice * item.quantity // 計算價格
        };
      });
      console.log(newTogoItems)
      console.log('togoId ' + togoId)
      // 發送請求將訂單明細發送到後端
      axios.post(`http://localhost:8080/SpanTasty/order/togo/${togoId}/items`, newTogoItems)
        .then(response => {
          if (response.data) {
            console.log('訂單明細建立成功');
            alert('訂單已送出')
            // 清除 localStorage 中的購物車資料
            localStorage.removeItem('cart');
            // 跳轉到成功頁面
            window.location.href = `/SpanTasty/StarCups/order/togo/information?id=${togoId}`;
          } else {
            console.log('訂單明細建立失敗');
          }
        })
        .catch(error => {
          console.error('上傳訂單明細過程中發生錯誤:', error);
        });
    }

    // 載入縣市列表
    function loadCities() {
      axios.get('http://localhost:8080/SpanTasty/restaurant/city')
        .then(function (response) {
          var citySelect = document.getElementById("citySelect");
          citySelect.innerHTML = '<option value="">選擇縣市</option>';
          response.data.forEach(function (city) {
            var option = document.createElement("option");
            option.value = city;
            option.text = city;
            citySelect.appendChild(option);
          });
        })
        .catch(function (error) {
          console.error("無法載入縣市資料", error);
        });
    }

    // 當用戶選擇縣市時，載入對應鄉鎮
    function fetchTowns() {
      var city = document.getElementById("citySelect").value;
      if (city) {
        axios.get(`http://localhost:8080/SpanTasty/restaurant/${city}/towns`)
          .then(function (response) {
            var townSelect = document.getElementById("townSelect");
            townSelect.innerHTML = '<option value="">選擇鄉鎮</option>';
            response.data.forEach(function (town) {
              var option = document.createElement("option");
              option.value = town;
              option.text = town;
              townSelect.appendChild(option);
            });
            townSelect.disabled = false;  // 啟用鄉鎮選單
          })
          .catch(function (error) {
            console.error("無法載入鄉鎮資料", error);
          });
      }
    }

    // 當用戶選擇鄉鎮時，載入對應餐廳
    function fetchRestaurants() {
      var town = document.getElementById("townSelect").value;
      if (town) {
        axios.get(`http://localhost:8080/SpanTasty/restaurant/${town}/list`)
          .then(function (response) {
            var restaurantSelect = document.getElementById("restaurantSelect");
            restaurantSelect.innerHTML = '<option value="">選擇餐廳</option>';
            response.data.forEach(function (restaurant) {
              var option = document.createElement("option");
              option.value = restaurant.restaurantId; // 餐廳的唯一 ID
              option.text = restaurant.restaurantName; // 餐廳名稱
              // option.text = restaurant.restaurantAddress;
              restaurantSelect.appendChild(option);
            });
            restaurantSelect.disabled = false;  // 啟用餐廳選單
          })
          .catch(function (error) {
            console.error("無法載入餐廳資料", error);
          });
      } else {
        document.getElementById("restaurantSelect").disabled = true;
      }
    }

    // 頁面載入時預先載入縣市選項
    window.onload = function () {
      loadCities();
    };

    function loadCartIntoTable() {
      // 從 localStorage 中獲取購物車數據
      const cart = JSON.parse(localStorage.getItem('cart')) || [];

      // 目標表格的 tbody 元素
      const tbody = document.querySelector(".table-custom.table-cart tbody");

      // 清空表格
      tbody.innerHTML = '';

      // 計算總金額
      let totalPrice = 0;

      // 如果購物車不為空，動態插入每個項目
      if (cart.length > 0) {
        cart.forEach(item => {
          const itemTotalPrice = item.foodPrice * item.quantity;
          totalPrice += itemTotalPrice;
          const rowHtml = `
          <tr>
            <td>
              <div class="table-cart-figure" style="margin-right: 30px;">
                <img src="${item.foodPicture}" alt="" width="146" height="132" />
              </div>
              <div class="table-cart-link">${item.foodName}</div>
            </td>
            <td>$${item.foodPrice}</td>
            <td>${item.quantity}</td>
            <td>$${itemTotalPrice}</td>
          </tr>`;

          // 插入新行到表格中
          tbody.insertAdjacentHTML('beforeend', rowHtml);
        });
      } else {
        // 如果購物車是空的，顯示一條提示信息
        tbody.innerHTML = `<tr><td colspan="4">購物車是空的。</td></tr>`;
      }

      // 更新總金額顯示
      document.querySelector(".cart-product-price").innerHTML = `<sup>$</sup>${totalPrice}`;

      // 將總金額放入表格中的 "Cart Subtotal" 和 "Total" 欄位
      document.getElementById("subtotal").innerText = `$${totalPrice}`;
      document.getElementById("total").innerText = `$${totalPrice}`;
    }

    // 取得會員資料
    function getProfile() {
      const token = localStorage.getItem('token');

      if (token) {
        axios.get('/SpanTasty/member/profile', {
          headers: {
            'Authorization': `${token}`
          }
        })
          .then(response => {
            if (response.data.success) {
              const member = response.data.data;
              // 取得 memberId
              const memberId = member.memberId;
              localStorage.setItem('memberId', memberId); // 儲存至 localStorage
              // memberId.textContent = member.memberId;
              // memberName.textContent = member.memberName;
              // phone.textContent = member.phone;
            } else {
              alert('無法獲取個人資訊');
            }
          })
          .catch(error => {
            console.error('獲取個人資訊過程中發生錯誤:', error);
          })
      } else {
        alert('請先登入')
      }
    }

  </script>
  <!-- Javascript-->
  <script src="/SpanTasty/starcups/js/core.min.js"></script>
  <script src="/SpanTasty/starcups/js/script.js"></script>
</body>

</html>